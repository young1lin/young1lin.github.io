<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Effective Java(with Spring core) | YL&#39;s Log</title>
<meta name="keywords" content="Effective Java">
<meta name="description" content="电子原版目录以及概要
请购买实体书籍，支持作者、翻译以及出版社
Creating and Destroying Objects
用静态工厂方法代替构造器
public static Boolean valueOf(boolean b){
  return b ? Boolean.TRUE : Boolean.FALSE;
}
静态工厂方法与设计模式中的工厂方法模式不同。并不能直接对应设计模式的工厂方法。
优势

有名字（像这种BigInteger.probablePrime(int bitLength,Random rnd)）
不必每次调用他们的时候，都创建一个新对象。像Integer.MAX_VALUE = 0x7fffffff（享元Flyweight模式）真正的享元模式如下，Integer中有个私有静态类，叫IntergeCache
可以返回原返回类型的任何子类型的对象。Java8允许接口中含有静态方法，Java9允许接口中有私有的静态方法，但是静态域和静态成员变量仍然需要是公有的。
所返回的对象的类可以随着每次调用而发生变化，这取决于静态工厂方法的参数值。
方法返回的对象所属的类，在便携包含该静态工厂方法的类时可以不存在。

public static Integer valueOf(int i) {
    if (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high)
        return IntegerCache.cache[i &#43; (-IntegerCache.low)];
    return new Integer(i);
}

private static class IntegerCache {
    static final int low = -128;
    static final int high;
    static final Integer cache[];

    static {
        // high value may be configured by property
        int h = 127;
        /** 
         * 这里定义了最大值，也就是说这个可以配置
         * -XX:AutoBoxCacheMax=NNN，这里的 NNN 表示最大值是多少，只能改最大值，不能改最小值。
         * 在设置了-XX:&#43;AggressiveOpts启动参数后，AutoBoxCacheMax的默认值会被修改为20000并且生效。
         * 这里的 -XX:&#43;AggressiveOpts 是表示加快编译
         * aggressive adj.好争斗的, 挑衅的, 侵略性的
         * export JAVA_OPTS=&#34;-Xms2048m -Xmx2048m&#34;。
         * 合起来翻译 积极的选择
         * - Tired compilers (hoping that it will make it into JDK7)
         * - Scalar replacement (and I am still hoping that this will remove some of the memory throughput preassure 64-bit brought)
         * EA and stack allocation
         * Code cache
         */ 
        String integerCacheHighPropValue = sun.misc.VM.getSavedProperty(&#34;java.lang.Integer.IntegerCache.high&#34;);
        if (integerCacheHighPropValue != null) {
            try {
                int i = parseInt(integerCacheHighPropValue);
                i = Math.max(i, 127);
                // Maximum array size is Integer.MAX_VALUE
                h = Math.min(i, Integer.MAX_VALUE - (-low) -1);
            } catch( NumberFormatException nfe) {
                // If the property cannot be parsed into an int, ignore it.
            }
        }
        high = h;

        cache = new Integer[(high - low) &#43; 1];
        int j = low;
        for(int k = 0; k &lt; cache.length; k&#43;&#43;)
            cache[k] = new Integer(j&#43;&#43;);

        // range [-128, 127] must be interned (JLS7 5.1.7)
        assert IntegerCache.high &gt;= 127;
    }
    private IntegerCache() {}
}
缺点">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/effective-java-spring/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4a977a24927dfcb104c05a21e8acc6782a45726abfb278fdc609607b38e0aa5c.css" integrity="sha256-Spd6JJJ9/LEEwFoh6KzGeCpFcmq/snj9xglgezjgqlw=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh-cn" href="http://localhost:1313/posts/effective-java-spring/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script>
document.addEventListener('DOMContentLoaded', function() {
    
    function initTOC() {
        const toc = document.querySelector('.toc');
        if (!toc) return;

        
        const headings = document.querySelectorAll('.post-content h1[id], .post-content h2[id], .post-content h3[id], .post-content h4[id], .post-content h5[id], .post-content h6[id]');
        const tocLinks = document.querySelectorAll('.toc a[href^="#"]');
        
        if (headings.length === 0 || tocLinks.length === 0) return;

        let currentActiveLink = null;
        
        
        function scrollTocToActiveItem(activeLink) {
            if (!activeLink) return;
            
            const tocContainer = document.querySelector('.toc');
            if (!tocContainer) return;
            
            const containerRect = tocContainer.getBoundingClientRect();
            const linkRect = activeLink.getBoundingClientRect();
            
            const linkTop = linkRect.top - containerRect.top + tocContainer.scrollTop;
            const containerHeight = tocContainer.clientHeight;
            const currentScrollTop = tocContainer.scrollTop;
            
            const targetScrollTop = linkTop - (containerHeight / 2) + (activeLink.offsetHeight / 2);
            
            const visibleTop = currentScrollTop + containerHeight * 0.2;
            const visibleBottom = currentScrollTop + containerHeight * 0.8;
            
            const needsScroll = linkTop < visibleTop || linkTop > visibleBottom;
            
            if (needsScroll) {
                tocContainer.scrollTo({
                    top: Math.max(0, Math.min(targetScrollTop, tocContainer.scrollHeight - containerHeight)),
                    behavior: 'smooth'
                });
            }
        }
        
        
        function removeAllActiveStates() {
            tocLinks.forEach(link => {
                link.classList.remove('active');
                link.style.fontWeight = '';
                link.style.color = '';
                link.style.backgroundColor = '';
            });
        }
        
        
        function setActiveLink(targetId) {
            removeAllActiveStates();
            
            const decodedTargetId = decodeURIComponent(targetId);
            
            let activeLink = null;
            
            activeLink = document.querySelector(`.toc a[href="#${targetId}"]`);
            
            if (!activeLink) {
                const encodedId = encodeURIComponent(targetId);
                activeLink = document.querySelector(`.toc a[href="#${encodedId}"]`);
            }
            
            if (!activeLink) {
                tocLinks.forEach(link => {
                    const linkHash = link.getAttribute('href').substring(1);
                    const decodedLinkHash = decodeURIComponent(linkHash);
                    if (decodedLinkHash === targetId || decodedLinkHash === decodedTargetId || linkHash === targetId) {
                        activeLink = link;
                    }
                });
            }
            
            if (activeLink) {
                activeLink.classList.add('active');
                activeLink.style.fontWeight = 'bold';
                activeLink.style.color = 'var(--primary)';
                activeLink.style.backgroundColor = 'var(--hover)';
                
                currentActiveLink = activeLink;
                scrollTocToActiveItem(activeLink);
            }
        }
        
        
        const observerOptions = {
            root: null,
            rootMargin: '-10% 0px -80% 0px',
            threshold: 0
        };
        
        const observer = new IntersectionObserver((entries) => {
            let visibleEntries = entries.filter(entry => entry.isIntersecting);
            
            if (visibleEntries.length > 0) {
                let topEntry = visibleEntries[0];
                let minTop = topEntry.boundingClientRect.top;
                
                visibleEntries.forEach(entry => {
                    const rect = entry.boundingClientRect;
                    if (rect.top < minTop && rect.top >= 0) {
                        minTop = rect.top;
                        topEntry = entry;
                    }
                });
                
                setActiveLink(topEntry.target.id);
            }
        }, observerOptions);
        
        
        headings.forEach(heading => {
            if (heading.id) {
                observer.observe(heading);
            }
        });
        
        
        tocLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const targetId = this.getAttribute('href').substring(1);
                const decodedTargetId = decodeURIComponent(targetId);
                
                let targetElement = document.getElementById(targetId) || document.getElementById(decodedTargetId);
                
                if (targetElement) {
                    const headerHeight = 80; 
                    const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                    const offsetPosition = elementPosition - headerHeight;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                    
                    setTimeout(() => {
                        setActiveLink(targetElement.id);
                    }, 100);
                }
            });
        });
        
        
        setTimeout(() => {
            const firstHeading = headings[0];
            if (firstHeading && firstHeading.id) {
                setActiveLink(firstHeading.id);
            }
        }, 500);
    }

    
    initTOC();

    
    function handleTocResponsive() {
        const screenWidth = window.innerWidth;
        const toc = document.querySelector('.toc');
        
        if (toc) {
            if (screenWidth <= 1200) {
                toc.style.display = 'none';
            } else {
                toc.style.display = 'block';
            }
        }
    }

    
    window.addEventListener('resize', handleTocResponsive);
    
    
    window.addEventListener('load', handleTocResponsive);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function initHeaderScroll() {
        const header = document.querySelector('.header');
        if (!header) return;

        let lastScrollTop = 0;
        const scrollThreshold = 50; 

        function handleScroll() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > scrollThreshold) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
            
            lastScrollTop = scrollTop;
        }

        
        let ticking = false;
        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(handleScroll);
                ticking = true;
                setTimeout(() => { ticking = false; }, 16);
            }
        }

        
        window.addEventListener('scroll', requestTick, { passive: true });
        
        
        handleScroll();
    }

    
    initHeaderScroll();

    
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        
        anchor.removeEventListener("click", arguments.callee);
        
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            const id = this.getAttribute("href").substr(1);
            const targetElement = document.querySelector(`[id='${decodeURIComponent(id)}']`);
            
            if (targetElement) {
                const headerHeight = 100; 
                const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                const offsetPosition = elementPosition - headerHeight;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
                
                if (id === "top") {
                    history.replaceState(null, null, " ");
                } else {
                    history.pushState(null, null, `#${id}`);
                }
            }
        });
    });
});
</script>

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="YL&#39;s Log (Alt + H)">YL&#39;s Log</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/films" title="电影">
                    <span>电影</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Effective Java(with Spring core)
    </h1>
    <div class="post-meta"><span title='2020-06-18 00:00:00 +0000 UTC'>June 18, 2020</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#creating-and-destroying-objects" aria-label="Creating and Destroying Objects">Creating and Destroying Objects</a><ul>
                        
                <li>
                    <a href="#%e7%94%a8%e9%9d%99%e6%80%81%e5%b7%a5%e5%8e%82%e6%96%b9%e6%b3%95%e4%bb%a3%e6%9b%bf%e6%9e%84%e9%80%a0%e5%99%a8" aria-label="用静态工厂方法代替构造器">用静态工厂方法代替构造器</a></li>
                <li>
                    <a href="#%e9%81%87%e5%88%b0%e5%a4%9a%e4%b8%aa%e6%9e%84%e9%80%a0%e5%99%a8%e5%8f%82%e6%95%b0%e6%97%b6%e8%a6%81%e8%80%83%e8%99%91%e4%bd%bf%e7%94%a8%e6%9e%84%e5%bb%ba%e5%99%a8" aria-label="遇到多个构造器参数时要考虑使用构建器">遇到多个构造器参数时要考虑使用构建器</a></li>
                <li>
                    <a href="#%e7%94%a8%e7%a7%81%e6%9c%89%e6%9e%84%e9%80%a0%e5%99%a8%e6%88%96%e8%80%85%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e5%bc%ba%e5%8c%96singleton%e5%b1%9e%e6%80%a7" aria-label="用私有构造器或者枚举类型强化Singleton属性">用私有构造器或者枚举类型强化Singleton属性</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87%e7%a7%81%e6%9c%89%e6%9e%84%e9%80%a0%e5%99%a8%e5%bc%ba%e5%8c%96%e4%b8%8d%e5%8f%af%e5%ae%9e%e4%be%8b%e5%8c%96%e7%9a%84%e8%83%bd%e5%8a%9b" aria-label="通过私有构造器强化不可实例化的能力">通过私有构造器强化不可实例化的能力</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e8%80%83%e8%99%91%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5%e6%9d%a5%e5%bc%95%e7%94%a8%e8%b5%84%e6%ba%90" aria-label="优先考虑依赖注入来引用资源">优先考虑依赖注入来引用资源</a></li>
                <li>
                    <a href="#%e9%81%bf%e5%85%8d%e5%88%9b%e5%bb%ba%e4%b8%8d%e5%bf%85%e8%a6%81%e7%9a%84%e5%af%b9%e8%b1%a1" aria-label="避免创建不必要的对象">避免创建不必要的对象</a></li>
                <li>
                    <a href="#%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8finalizer%e6%96%b9%e6%b3%95%e5%92%8cjava9%e7%9a%84cleaner%e6%96%b9%e6%b3%95" aria-label="避免使用finalizer方法，和Java9的cleaner方法">避免使用finalizer方法，和Java9的cleaner方法</a></li>
                <li>
                    <a href="#try-with-resources-%e4%bc%98%e5%85%88%e4%ba%8e-try-finally" aria-label="try with resources 优先于 try finally">try with resources 优先于 try finally</a></li></ul>
                </li>
                <li>
                    <a href="#methods-common-to-all-objects" aria-label="Methods Common to All Objects">Methods Common to All Objects</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%97%b6%e5%80%99%e5%ba%94%e8%af%a5%e8%a6%86%e7%9b%96equals%e6%96%b9%e6%b3%95" aria-label="什么时候应该覆盖equals方法？">什么时候应该覆盖equals方法？</a></li>
                <li>
                    <a href="#%e8%a6%86%e7%9b%96-equals-%e6%97%b6%e6%80%bb%e8%a6%81%e8%a6%86%e7%9b%96-hashcode" aria-label="覆盖 equals 时总要覆盖 hashCode">覆盖 equals 时总要覆盖 hashCode</a></li>
                <li>
                    <a href="#%e5%a7%8b%e7%bb%88%e8%a6%81%e8%a6%86%e7%9b%96tostring" aria-label="始终要覆盖toString">始终要覆盖toString</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e5%9c%b0%e8%a6%86%e7%9b%96-clone" aria-label="谨慎地覆盖 clone">谨慎地覆盖 clone</a></li>
                <li>
                    <a href="#%e8%80%83%e8%99%91%e5%ae%9e%e7%8e%b0-comparable-%e6%8e%a5%e5%8f%a3" aria-label="考虑实现 Comparable 接口">考虑实现 Comparable 接口</a></li></ul>
                </li>
                <li>
                    <a href="#classes-and-interfaces" aria-label="Classes and Interfaces">Classes and Interfaces</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%b1%bb%e5%92%8c%e6%88%90%e5%91%98%e7%9a%84%e5%8f%af%e8%ae%bf%e9%97%ae%e6%80%a7%e6%9c%80%e5%b0%8f%e5%8c%96" aria-label="使类和成员的可访问性最小化">使类和成员的可访问性最小化</a></li>
                <li>
                    <a href="#%e4%bd%bf%e5%8f%af%e5%8f%98%e6%80%a7%e6%9c%80%e5%b0%8f%e5%8c%96" aria-label="使可变性最小化">使可变性最小化</a></li>
                <li>
                    <a href="#%e5%a4%8d%e5%90%88%e4%bc%98%e4%ba%8e%e7%bb%a7%e6%89%bf" aria-label="复合优于继承">复合优于继承</a></li>
                <li>
                    <a href="#%e8%a6%81%e4%b9%88%e8%ae%be%e8%ae%a1%e7%bb%a7%e6%89%bf%e5%b9%b6%e6%8f%90%e4%be%9b%e6%96%87%e6%a1%a3%e8%af%b4%e6%98%8e%e8%a6%81%e4%b9%88%e7%a6%81%e6%ad%a2%e7%bb%a7%e6%89%bf" aria-label="要么设计继承并提供文档说明，要么禁止继承">要么设计继承并提供文档说明，要么禁止继承</a></li>
                <li>
                    <a href="#%e6%8e%a5%e5%8f%a3%e4%bc%98%e4%ba%8e%e6%8a%bd%e8%b1%a1%e7%b1%bb" aria-label="接口优于抽象类">接口优于抽象类</a></li>
                <li>
                    <a href="#%e4%b8%ba%e5%90%8e%e4%bb%a3%e8%ae%be%e8%ae%a1%e6%8e%a5%e5%8f%a3" aria-label="为后代设计接口">为后代设计接口</a></li>
                <li>
                    <a href="#%e6%8e%a5%e5%8f%a3%e5%8f%aa%e7%94%a8%e4%ba%8e%e5%ae%9a%e4%b9%89%e7%b1%bb%e5%9e%8b" aria-label="接口只用于定义类型">接口只用于定义类型</a></li>
                <li>
                    <a href="#%e7%b1%bb%e5%b1%82%e6%ac%a1%e4%bc%98%e5%85%88%e4%ba%8e%e6%a0%87%e7%ad%be%e7%b1%bb" aria-label="类层次优先于标签类">类层次优先于标签类</a></li>
                <li>
                    <a href="#%e9%9d%99%e6%80%81%e6%88%90%e5%91%98%e7%b1%bb%e4%bc%98%e5%85%88%e4%ba%8e%e9%9d%9e%e9%9d%99%e6%80%81%e6%88%90%e5%91%98%e7%b1%bb" aria-label="静态成员类优先于非静态成员类">静态成员类优先于非静态成员类</a></li>
                <li>
                    <a href="#%e9%99%90%e5%88%b6%e6%ba%90%e6%96%87%e4%bb%b6%e4%b8%ba%e5%8d%95%e4%b8%aa%e9%a1%b6%e7%ba%a7%e7%b1%bbpublic-%e4%bf%ae%e9%a5%b0%e4%b8%8e%e6%96%87%e4%bb%b6%e5%90%8d%e7%9b%b8%e5%90%8c%e7%9a%84%e7%b1%bb" aria-label="限制源文件为单个顶级类(public 修饰与文件名相同的类)">限制源文件为单个顶级类(public 修饰与文件名相同的类)</a></li></ul>
                </li>
                <li>
                    <a href="#generics" aria-label="Generics">Generics</a><ul>
                        
                <li>
                    <a href="#%e4%b8%8d%e8%a6%81%e4%bd%bf%e7%94%a8%e5%8e%9f%e7%94%9f%e6%80%81%e7%b1%bb%e5%9e%8b" aria-label="不要使用原生态类型">不要使用原生态类型</a></li>
                <li>
                    <a href="#%e6%b6%88%e9%99%a4%e9%9d%9e%e5%8f%97%e6%a3%80%e7%9a%84%e8%ad%a6%e5%91%8a" aria-label="消除非受检的警告">消除非受检的警告</a></li>
                <li>
                    <a href="#%e5%88%97%e8%a1%a8%e4%bc%98%e5%85%88%e4%ba%8e%e6%95%b0%e7%bb%84" aria-label="列表优先于数组">列表优先于数组</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e8%80%83%e8%99%91%e8%8c%83%e5%9e%8b" aria-label="优先考虑范型">优先考虑范型</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e8%80%83%e8%99%91%e8%8c%83%e5%9e%8b%e6%96%b9%e6%b3%95-" aria-label="优先考虑范型方法 ⬆️">优先考虑范型方法 ⬆️</a></li>
                <li>
                    <a href="#%e5%88%a9%e7%94%a8%e6%9c%89%e9%99%90%e5%88%b6%e9%80%9a%e9%85%8d%e7%ac%a6%e6%9d%a5%e6%8f%90%e5%8d%87-api-%e7%9a%84%e7%81%b5%e6%b4%bb%e6%80%a7" aria-label="利用有限制通配符来提升 API 的灵活性">利用有限制通配符来提升 API 的灵活性</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e4%bd%bf%e7%94%a8%e5%b9%b6%e7%94%a8%e8%8c%83%e5%9e%8b%e5%92%8c%e5%8f%af%e5%8f%98%e5%8f%82%e6%95%b0" aria-label="谨慎使用并用范型和可变参数">谨慎使用并用范型和可变参数</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e8%80%83%e8%99%91%e7%b1%bb%e5%9e%8b%e5%ae%89%e5%85%a8%e7%9a%84%e5%bc%82%e6%9e%84%e5%ae%b9%e5%99%a8" aria-label="优先考虑类型安全的异构容器">优先考虑类型安全的异构容器</a></li></ul>
                </li>
                <li>
                    <a href="#enums-and-annotations" aria-label="Enums and Annotations">Enums and Annotations</a><ul>
                        
                <li>
                    <a href="#%e7%94%a8-enum-%e4%bb%a3%e6%9b%bf-int-%e5%b8%b8%e9%87%8f" aria-label="用 enum 代替 int 常量">用 enum 代替 int 常量</a></li>
                <li>
                    <a href="#%e7%94%a8%e5%ae%9e%e4%be%8b%e5%9f%9f%e4%bb%a3%e6%9b%bf%e5%ba%8f%e6%95%b0%e8%a1%a8%e7%a4%ba%e6%ac%a1%e5%ba%8f%e7%9a%84%e6%95%b0%e7%9b%ae" aria-label="用实例域代替序数（表示次序的数目）">用实例域代替序数（表示次序的数目）</a></li>
                <li>
                    <a href="#%e7%94%a8-enumset-%e4%bb%a3%e6%9b%bf%e4%bd%8d%e5%9f%9f" aria-label="用 EnumSet 代替位域">用 EnumSet 代替位域</a></li>
                <li>
                    <a href="#%e7%94%a8-enummap-%e4%bb%a3%e6%9b%bf%e5%ba%8f%e6%95%b0%e7%b4%a2%e5%bc%95" aria-label="用 EnumMap 代替序数索引">用 EnumMap 代替序数索引</a></li>
                <li>
                    <a href="#%e7%94%a8%e6%8e%a5%e5%8f%a3%e6%a8%a1%e6%8b%9f%e5%8f%af%e6%89%a9%e5%b1%95%e7%9a%84%e6%9e%9a%e4%b8%be" aria-label="用接口模拟可扩展的枚举">用接口模拟可扩展的枚举</a></li>
                <li>
                    <a href="#%e6%b3%a8%e8%a7%a3%e4%bc%98%e5%85%88%e4%ba%8e%e5%91%bd%e5%90%8d%e6%a8%a1%e5%bc%8f" aria-label="注解优先于命名模式">注解优先于命名模式</a></li>
                <li>
                    <a href="#%e5%9d%9a%e6%8c%81%e4%bd%bf%e7%94%a8-override-%e6%b3%a8%e8%a7%a3" aria-label="坚持使用 @Override 注解">坚持使用 @Override 注解</a></li>
                <li>
                    <a href="#%e7%94%a8%e6%a0%87%e8%ae%b0%e6%8e%a5%e5%8f%a3%e5%ae%9a%e4%b9%89%e7%b1%bb%e5%9e%8b" aria-label="用标记接口定义类型">用标记接口定义类型</a></li></ul>
                </li>
                <li>
                    <a href="#lambdas-and-streams" aria-label="Lambdas and Streams">Lambdas and Streams</a><ul>
                        
                <li>
                    <a href="#lambda-%e4%bc%98%e5%85%88%e4%ba%8e%e5%8c%bf%e5%90%8d%e7%b1%bb" aria-label="Lambda 优先于匿名类">Lambda 优先于匿名类</a></li>
                <li>
                    <a href="#%e6%96%b9%e6%b3%95%e5%bc%95%e7%94%a8%e4%bc%98%e5%85%88%e4%ba%8e-lambda" aria-label="方法引用优先于 Lambda">方法引用优先于 Lambda</a></li>
                <li>
                    <a href="#%e5%9d%9a%e6%8c%81%e4%bd%bf%e7%94%a8%e6%a0%87%e5%87%86%e7%9a%84%e5%87%bd%e6%95%b0%e6%8e%a5%e5%8f%a3" aria-label="坚持使用标准的函数接口">坚持使用标准的函数接口</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e4%bd%bf%e7%94%a8-stream" aria-label="谨慎使用 Stream">谨慎使用 Stream</a></li></ul>
                </li>
                <li>
                    <a href="#methods" aria-label="Methods">Methods</a><ul>
                        
                <li>
                    <a href="#%e6%a3%80%e6%9f%a5%e5%8f%82%e6%95%b0%e7%9a%84%e6%9c%89%e6%95%88%e6%80%a7" aria-label="检查参数的有效性">检查参数的有效性</a></li>
                <li>
                    <a href="#%e5%bf%85%e8%a6%81%e6%97%b6%e8%bf%9b%e8%a1%8c%e4%bf%9d%e6%8a%a4%e6%80%a7%e6%8b%b7%e8%b4%9d" aria-label="必要时进行保护性拷贝">必要时进行保护性拷贝</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e8%ae%be%e8%ae%a1%e6%96%b9%e6%b3%95%e7%ad%be%e5%90%8d" aria-label="谨慎设计方法签名">谨慎设计方法签名</a></li>
                <li>
                    <a href="#%e6%85%8e%e7%94%a8%e9%87%8d%e8%bd%bd" aria-label="慎用重载">慎用重载</a></li>
                <li>
                    <a href="#%e6%85%8e%e7%94%a8%e5%8f%af%e5%8f%98%e5%8f%82%e6%95%b0" aria-label="慎用可变参数">慎用可变参数</a></li>
                <li>
                    <a href="#%e8%bf%94%e5%9b%9e%e9%9b%b6%e9%95%bf%e5%ba%a6%e7%9a%84%e6%95%b0%e7%bb%84%e6%88%96%e8%80%85%e9%9b%86%e5%90%88%e8%80%8c%e4%b8%8d%e6%98%af-null" aria-label="返回零长度的数组或者集合，而不是 null">返回零长度的数组或者集合，而不是 null</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e8%bf%94%e5%9b%9e-optional" aria-label="谨慎返回 optional">谨慎返回 optional</a></li>
                <li>
                    <a href="#%e4%b8%ba%e6%89%80%e6%9c%89%e5%88%b0%e5%a4%84%e7%9a%84-api-%e5%85%83%e7%b4%a0%e7%bc%96%e5%86%99%e6%96%87%e6%a1%a3%e6%b3%a8%e9%87%8a" aria-label="为所有到处的 API 元素编写文档注释">为所有到处的 API 元素编写文档注释</a></li></ul>
                </li>
                <li>
                    <a href="#general-programing" aria-label="General Programing">General Programing</a><ul>
                        
                <li>
                    <a href="#%e5%b0%86%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e7%9a%84%e4%bd%9c%e7%94%a8%e5%9f%9f%e6%9c%80%e5%b0%8f%e5%8c%96" aria-label="将局部变量的作用域最小化">将局部变量的作用域最小化</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e4%bd%bf%e7%94%a8-foreach-%e8%80%8c%e4%b8%8d%e6%98%af-for" aria-label="优先使用 foreach 而不是 for">优先使用 foreach 而不是 for</a></li>
                <li>
                    <a href="#%e4%ba%86%e8%a7%a3%e5%92%8c%e4%bd%bf%e7%94%a8%e7%b1%bb%e5%ba%93" aria-label="了解和使用类库">了解和使用类库</a></li>
                <li>
                    <a href="#%e5%a6%82%e6%9e%9c%e9%9c%80%e8%a6%81%e7%b2%be%e7%a1%ae%e7%9a%84%e7%ad%94%e6%a1%88%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8-float-%e5%92%8c-double" aria-label="如果需要精确的答案，避免使用 float 和 double">如果需要精确的答案，避免使用 float 和 double</a></li>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e7%b1%bb%e5%9e%8b%e4%bc%98%e5%85%88%e4%ba%8e%e8%a3%85%e7%ae%b1%e5%9f%ba%e6%9c%ac%e7%b1%bb%e5%9e%8b" aria-label="基本类型优先于装箱基本类型">基本类型优先于装箱基本类型</a></li>
                <li>
                    <a href="#%e5%a6%82%e6%9e%9c%e5%85%b6%e4%bb%96%e7%b1%bb%e5%9e%8b%e6%9b%b4%e5%90%88%e9%80%82%e5%b0%bd%e9%87%8f%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8%e5%ad%97%e7%ac%a6%e4%b8%b2" aria-label="如果其他类型更合适，尽量避免使用字符串">如果其他类型更合适，尽量避免使用字符串</a></li>
                <li>
                    <a href="#%e4%ba%86%e8%a7%a3%e5%ad%97%e7%ac%a6%e4%b8%b2%e8%bf%9e%e6%8e%a5%e7%9a%84%e6%80%a7%e8%83%bd" aria-label="了解字符串连接的性能">了解字符串连接的性能</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87%e6%8e%a5%e5%8f%a3%e5%bc%95%e7%94%a8%e5%af%b9%e8%b1%a1" aria-label="通过接口引用对象">通过接口引用对象</a><ul>
                        
                <li>
                    <a href="#%e6%a0%b7%e4%be%8b" aria-label="样例">样例</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8e%a5%e5%8f%a3%e4%bc%98%e5%85%88%e4%ba%8e%e5%8f%8d%e5%b0%84%e6%9c%ba%e5%88%b6" aria-label="接口优先于反射机制">接口优先于反射机制</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e4%bd%bf%e7%94%a8%e6%9c%ac%e5%9c%b0%e6%96%b9%e6%b3%95" aria-label="谨慎使用本地方法">谨慎使用本地方法</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e5%9c%b0%e8%bf%9b%e8%a1%8c%e4%bc%98%e5%8c%96" aria-label="谨慎地进行优化">谨慎地进行优化</a></li>
                <li>
                    <a href="#%e9%81%b5%e5%ae%88%e6%99%ae%e9%81%8d%e6%8e%a5%e5%8f%97%e7%9a%84%e5%91%bd%e5%90%8d%e6%83%af%e4%be%8b" aria-label="遵守普遍接受的命名惯例">遵守普遍接受的命名惯例</a><ul>
                        
                <li>
                    <a href="#%e9%a2%98%e5%a4%96%e8%af%9d" aria-label="题外话">题外话</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#exception" aria-label="Exception">Exception</a><ul>
                        
                <li>
                    <a href="#%e5%8f%aa%e9%92%88%e5%af%b9%e5%bc%82%e5%b8%b8%e7%9a%84%e6%83%85%e5%86%b5%e6%89%8d%e4%bd%bf%e7%94%a8%e5%bc%82%e5%b8%b8" aria-label="只针对异常的情况才使用异常">只针对异常的情况才使用异常</a></li>
                <li>
                    <a href="#%e5%af%b9%e5%8f%af%e6%81%a2%e5%a4%8d%e7%9a%84%e6%83%85%e5%86%b5%e4%bd%bf%e7%94%a8%e5%8f%97%e6%a3%80%e5%bc%82%e5%b8%b8%e5%af%b9%e7%bc%96%e7%a8%8b%e9%94%99%e8%af%af%e4%bd%bf%e7%94%a8%e8%bf%90%e8%a1%8c%e6%97%b6%e5%bc%82%e5%b8%b8" aria-label="对可恢复的情况使用受检异常，对编程错误使用运行时异常">对可恢复的情况使用受检异常，对编程错误使用运行时异常</a></li>
                <li>
                    <a href="#%e9%81%bf%e5%85%8d%e4%b8%8d%e5%bf%85%e8%a6%81%e5%9c%b0%e4%bd%bf%e7%94%a8%e5%8f%97%e6%a3%80%e5%bc%82%e5%b8%b8" aria-label="避免不必要地使用受检异常">避免不必要地使用受检异常</a></li>
                <li>
                    <a href="#%e4%bc%98%e5%85%88%e4%bd%bf%e7%94%a8%e6%a0%87%e5%87%86%e7%9a%84%e5%bc%82%e5%b8%b8" aria-label="优先使用标准的异常">优先使用标准的异常</a></li>
                <li>
                    <a href="#%e6%8a%9b%e5%87%ba%e4%b8%8e%e6%8a%bd%e8%b1%a1%e5%af%b9%e5%ba%94%e7%9a%84%e5%bc%82%e5%b8%b8" aria-label="抛出与抽象对应的异常">抛出与抽象对应的异常</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%b8%aa%e6%96%b9%e6%b3%95%e6%8a%9b%e5%87%ba%e7%9a%84%e6%89%80%e6%9c%89%e5%bc%82%e5%b8%b8%e9%83%bd%e8%a6%81%e5%bb%ba%e7%ab%8b%e6%96%87%e6%a1%a3" aria-label="每个方法抛出的所有异常都要建立文档">每个方法抛出的所有异常都要建立文档</a></li>
                <li>
                    <a href="#%e5%9c%a8%e7%bb%86%e8%8a%82%e6%b6%88%e6%81%af%e4%b8%ad%e5%8c%85%e5%90%ab%e5%a4%b1%e8%b4%a5-%e6%8d%95%e8%8e%b7%e4%bf%a1%e6%81%af" aria-label="在细节消息中包含失败-捕获信息">在细节消息中包含失败-捕获信息</a></li>
                <li>
                    <a href="#%e5%8a%aa%e5%8a%9b%e4%bd%bf%e5%a4%b1%e8%b4%a5%e4%bf%9d%e6%8c%81%e5%8e%9f%e5%ad%90%e6%80%a7" aria-label="努力使失败保持原子性">努力使失败保持原子性</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%a6%81%e5%bf%bd%e7%95%a5%e5%bc%82%e5%b8%b8" aria-label="不要忽略异常">不要忽略异常</a></li></ul>
                </li>
                <li>
                    <a href="#concurrency" aria-label="Concurrency">Concurrency</a><ul>
                        
                <li>
                    <a href="#%e5%90%8c%e6%ad%a5%e8%ae%bf%e9%97%ae%e5%85%b1%e4%ba%ab%e7%9a%84%e5%8f%af%e5%8f%98%e6%95%b0%e6%8d%ae" aria-label="同步访问共享的可变数据">同步访问共享的可变数据</a></li>
                <li>
                    <a href="#%e9%81%bf%e5%85%8d%e8%bf%87%e5%ba%a6%e5%90%8c%e6%ad%a5" aria-label="避免过度同步">避免过度同步</a></li>
                <li>
                    <a href="#executortaskstream-%e4%bc%98%e5%85%88%e4%ba%8e%e7%ba%bf%e7%a8%8b" aria-label="executor、task、stream 优先于线程">executor、task、stream 优先于线程</a><ul>
                        
                <li>
                    <a href="#%e9%a5%b1%e5%92%8c%e7%ad%96%e7%95%a5" aria-label="饱和策略">饱和策略</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b9%b6%e5%8f%91%e5%b7%a5%e5%85%b7%e4%bc%98%e5%85%88%e4%ba%8e-wait-%e5%92%8c-notify" aria-label="并发工具优先于 wait 和 notify">并发工具优先于 wait 和 notify</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e6%80%a7%e7%9a%84%e6%96%87%e6%a1%a3%e5%8c%96" aria-label="线程安全性的文档化">线程安全性的文档化</a></li>
                <li>
                    <a href="#%e6%85%8e%e7%94%a8%e5%bb%b6%e8%bf%9f%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="慎用延迟初始化">慎用延迟初始化</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%a6%81%e4%be%9d%e8%b5%96%e4%ba%8e%e7%ba%bf%e7%a8%8b%e8%b0%83%e5%ba%a6%e5%99%a8" aria-label="不要依赖于线程调度器">不要依赖于线程调度器</a></li></ul>
                </li>
                <li>
                    <a href="#serialize" aria-label="Serialize">Serialize</a><ul>
                        
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e6%96%b9%e6%b3%95%e4%bc%98%e5%85%88%e4%ba%8e-java-%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="其他方法优先于 Java 序列化">其他方法优先于 Java 序列化</a></li>
                <li>
                    <a href="#%e8%b0%a8%e6%85%8e%e5%9c%b0%e5%ae%9e%e7%8e%b0-serializable-%e6%8e%a5%e5%8f%a3" aria-label="谨慎地实现 Serializable 接口">谨慎地实现 Serializable 接口</a></li>
                <li>
                    <a href="#%e8%80%83%e8%99%91%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e7%9a%84%e5%ba%8f%e5%88%97%e5%8c%96%e5%bd%a2%e5%bc%8f" aria-label="考虑使用自定义的序列化形式">考虑使用自定义的序列化形式</a></li>
                <li>
                    <a href="#%e4%bf%9d%e6%8a%a4%e6%80%a7%e5%9c%b0%e7%bc%96%e5%86%99-readobject-%e6%96%b9%e6%b3%95" aria-label="保护性地编写 readObject 方法">保护性地编写 readObject 方法</a></li>
                <li>
                    <a href="#%e5%af%b9%e4%ba%8e%e5%ae%9e%e4%be%8b%e6%8e%a7%e5%88%b6%e6%9e%9a%e4%b8%be%e7%b1%bb%e5%9e%8b%e4%bc%98%e5%85%88%e4%ba%8e-readobject" aria-label="对于实例控制，枚举类型优先于 readObject">对于实例控制，枚举类型优先于 readObject</a></li>
                <li>
                    <a href="#%e8%80%83%e8%99%91%e7%94%a8%e5%ba%8f%e5%88%97%e5%8c%96%e4%bb%a3%e7%90%86%e4%bb%a3%e6%9b%bf%e5%ba%8f%e5%88%97%e5%8c%96%e5%ae%9e%e4%be%8b" aria-label="考虑用序列化代理代替序列化实例">考虑用序列化代理代替序列化实例</a></li></ul>
                </li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p><a href="https://www.oreilly.com/library/view/effective-java/9780134686097/">电子原版目录以及概要</a></p>
<p>请购买实体书籍，支持作者、翻译以及出版社</p>
<h1 id="creating-and-destroying-objects">Creating and Destroying Objects<a hidden class="anchor" aria-hidden="true" href="#creating-and-destroying-objects">#</a></h1>
<h2 id="用静态工厂方法代替构造器">用静态工厂方法代替构造器<a hidden class="anchor" aria-hidden="true" href="#用静态工厂方法代替构造器">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Boolean <span style="color:#a6e22e">valueOf</span>(<span style="color:#66d9ef">boolean</span> b){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> b <span style="color:#f92672">?</span> Boolean.<span style="color:#a6e22e">TRUE</span> : Boolean.<span style="color:#a6e22e">FALSE</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>静态工厂方法与设计模式中的工厂方法模式不同。并不能直接对应设计模式的工厂方法。</p>
<p><strong>优势</strong></p>
<ul>
<li>有名字（像这种<code>BigInteger.probablePrime(int bitLength,Random rnd)</code>）</li>
<li>不必每次调用他们的时候，都创建一个新对象。像<code>Integer.MAX_VALUE = 0x7fffffff</code>（享元<code>Flyweight</code>模式）真正的享元模式如下，<code>Integer</code>中有个私有静态类，叫<code>IntergeCache</code></li>
<li>可以返回原返回类型的任何子类型的对象。<code>Java8</code>允许接口中含有静态方法，<code>Java9</code>允许接口中有私有的静态方法，但是静态域和静态成员变量仍然需要是公有的。</li>
<li>所返回的对象的类可以随着每次调用而发生变化，这取决于静态工厂方法的参数值。</li>
<li>方法返回的对象所属的类，在便携包含该静态工厂方法的类时可以不存在。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Integer <span style="color:#a6e22e">valueOf</span>(<span style="color:#66d9ef">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> IntegerCache.<span style="color:#a6e22e">low</span> <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;=</span> IntegerCache.<span style="color:#a6e22e">high</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> IntegerCache.<span style="color:#a6e22e">cache</span><span style="color:#f92672">[</span>i <span style="color:#f92672">+</span> (<span style="color:#f92672">-</span>IntegerCache.<span style="color:#a6e22e">low</span>)<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Integer(i);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IntegerCache</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> low <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>128;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> high;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Integer cache<span style="color:#f92672">[]</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// high value may be configured by property</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> h <span style="color:#f92672">=</span> 127;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/** 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 这里定义了最大值，也就是说这个可以配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * -XX:AutoBoxCacheMax=NNN，这里的 NNN 表示最大值是多少，只能改最大值，不能改最小值。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 在设置了-XX:+AggressiveOpts启动参数后，AutoBoxCacheMax的默认值会被修改为20000并且生效。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 这里的 -XX:+AggressiveOpts 是表示加快编译
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * aggressive adj.好争斗的, 挑衅的, 侵略性的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * export JAVA_OPTS=&#34;-Xms2048m -Xmx2048m&#34;。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 合起来翻译 积极的选择
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * - Tired compilers (hoping that it will make it into JDK7)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * - Scalar replacement (and I am still hoping that this will remove some of the memory throughput preassure 64-bit brought)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * EA and stack allocation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * Code cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span> 
</span></span><span style="display:flex;"><span>        String integerCacheHighPropValue <span style="color:#f92672">=</span> sun.<span style="color:#a6e22e">misc</span>.<span style="color:#a6e22e">VM</span>.<span style="color:#a6e22e">getSavedProperty</span>(<span style="color:#e6db74">&#34;java.lang.Integer.IntegerCache.high&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (integerCacheHighPropValue <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> parseInt(integerCacheHighPropValue);
</span></span><span style="display:flex;"><span>                i <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">max</span>(i, 127);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Maximum array size is Integer.MAX_VALUE</span>
</span></span><span style="display:flex;"><span>                h <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>(i, Integer.<span style="color:#a6e22e">MAX_VALUE</span> <span style="color:#f92672">-</span> (<span style="color:#f92672">-</span>low) <span style="color:#f92672">-</span>1);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span>( NumberFormatException nfe) {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// If the property cannot be parsed into an int, ignore it.</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        high <span style="color:#f92672">=</span> h;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cache <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Integer<span style="color:#f92672">[</span>(high <span style="color:#f92672">-</span> low) <span style="color:#f92672">+</span> 1<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> low;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> k <span style="color:#f92672">=</span> 0; k <span style="color:#f92672">&lt;</span> cache.<span style="color:#a6e22e">length</span>; k<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>            cache<span style="color:#f92672">[</span>k<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Integer(j<span style="color:#f92672">++</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// range [-128, 127] must be interned (JLS7 5.1.7)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> IntegerCache.<span style="color:#a6e22e">high</span> <span style="color:#f92672">&gt;=</span> 127;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">IntegerCache</span>() {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>缺点</p>
<ul>
<li>类如果不含公有或者受保护的构造器，就不能被子类化</li>
<li>难发现它们</li>
</ul>
<p><code>BeanDefinitionBuiler</code> 就是将<code>静态工厂方法</code> 和 <code>构建器</code> 模式结合的案例。</p>
<h2 id="遇到多个构造器参数时要考虑使用构建器">遇到多个构造器参数时要考虑使用构建器<a hidden class="anchor" aria-hidden="true" href="#遇到多个构造器参数时要考虑使用构建器">#</a></h2>
<ul>
<li>
<p><code>JavaBean</code>模式（不推荐，当然我觉得不包括 <code>POJO</code> 类）</p>
</li>
<li>
<p><code>Builder</code>模式（<code>lombok</code>提供了<code>@Builder</code>注解，可以偷懒，但是就不要注解了，可以在顶部菜单栏<code>Refactor</code>使用 <code>delomok</code>生成相应代码）</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 样例</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// spring-beans 下。</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BeanDefinitionBuilder</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AbstractBeanDefinition beanDefinition;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> constructorArgIndex;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回一般 BeanDefinitionBuilder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> BeanDefinitionBuilder <span style="color:#a6e22e">genericBeanDefinition</span>(String beanClassName) {
</span></span><span style="display:flex;"><span>        BeanDefinitionBuilder builder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanDefinitionBuilder(<span style="color:#66d9ef">new</span> GenericBeanDefinition());
</span></span><span style="display:flex;"><span>        builder.<span style="color:#a6e22e">beanDefinition</span>.<span style="color:#a6e22e">setBeanClassName</span>(beanClassName);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> builder;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略其他相同类型方法.....</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// init-method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BeanDefinitionBuilder <span style="color:#a6e22e">setInitMethodName</span>(<span style="color:#a6e22e">@Nullable</span> String methodName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanDefinition</span>.<span style="color:#a6e22e">setInitMethodName</span>(methodName);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// detroy-method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BeanDefinitionBuilder <span style="color:#a6e22e">setDestroyMethodName</span>(<span style="color:#a6e22e">@Nullable</span> String methodName) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanDefinition</span>.<span style="color:#a6e22e">setDestroyMethodName</span>(methodName);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// scope  defualt singleton</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BeanDefinitionBuilder <span style="color:#a6e22e">setScope</span>(<span style="color:#a6e22e">@Nullable</span> String scope) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanDefinition</span>.<span style="color:#a6e22e">setScope</span>(scope);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略其他类型方法....</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> AbstractBeanDefinition <span style="color:#a6e22e">getBeanDefinition</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanDefinition</span>.<span style="color:#a6e22e">validate</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanDefinition</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//使用</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BeanDefinitionAPI</span>{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> GenericBeanDefinition <span style="color:#a6e22e">getGeneriBeanDefinition</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (GenericBeanDefinition)BeanDefinitionBuilder
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">genericBeanDefinition</span>(<span style="color:#e6db74">&#34;org.springframework.web.client.RestTemplate&#34;</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">setScope</span>(<span style="color:#e6db74">&#34;singleton&#34;</span>)
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">getBeanDefinition</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><em style = "color:blue">如果类的构造器或者静态工厂中具有多个参数，设计这种类时，Builder模式就是一种不错的选择</em></p>
<h2 id="用私有构造器或者枚举类型强化singleton属性">用私有构造器或者枚举类型强化<code>Singleton</code>属性<a hidden class="anchor" aria-hidden="true" href="#用私有构造器或者枚举类型强化singleton属性">#</a></h2>
<p><em style="color:blue">如果要阻止反射实例化单例类，可以在被要求创建第二个实例的时候，抛出异常。</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 描述：这种方式采用双锁机制，安全且在多线程情况下能保持高性能。getInstance() 的性能对应用程序很关键。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 双检锁/双重校验锁（DCL，即 double-checked locking）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> Singleton singleton <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Singleton</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//这里检查是不是初始化过了</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(singleton <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalAccessException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">getInstance</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(singleton <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">synchronized</span>(Singleton.<span style="color:#a6e22e">class</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(singleton <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                    singleton <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Singleton();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> singleton;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>单元素的枚举类型经常成为实现<code>Singleton</code>的最佳方法。当然如果<code>Singleton</code>必须扩展一个超类，而不是扩展<code>Enum</code>的时候，则不宜使用这个方法。</p>
<p>下面是 Spring Boot 2.0 引入的单例类。具体执行顺序如下</p>
<p><code>SpringApplication#run --&gt; SpringApplication#prepareEnvironment --&gt; SpringApplication#configureEnvironment --&gt; ApplicationConversionService#getSharedInstance</code>
也是使用 DCL 思想（我觉得应该从 Stackoverflow 上面复制的）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationConversionService</span> <span style="color:#66d9ef">extends</span> FormattingConversionService {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">volatile</span> ApplicationConversionService sharedInstance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ApplicationConversionService</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>(<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ApplicationConversionService</span>(StringValueResolver embeddedValueResolver) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (embeddedValueResolver <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         setEmbeddedValueResolver(embeddedValueResolver);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      configure(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Return a shared default application {@code ConversionService} instance, lazily
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * building it once needed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * &lt;p&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Note: This method actually returns an {@link ApplicationConversionService}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * instance. However, the {@code ConversionService} signature has been preserved for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * binary compatibility.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @return the shared {@code ApplicationConversionService} instance (never
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * {@code null})
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ConversionService <span style="color:#a6e22e">getSharedInstance</span>() {
</span></span><span style="display:flex;"><span>      ApplicationConversionService sharedInstance <span style="color:#f92672">=</span> ApplicationConversionService.<span style="color:#a6e22e">sharedInstance</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (sharedInstance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">synchronized</span> (ApplicationConversionService.<span style="color:#a6e22e">class</span>) {
</span></span><span style="display:flex;"><span>            sharedInstance <span style="color:#f92672">=</span> ApplicationConversionService.<span style="color:#a6e22e">sharedInstance</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (sharedInstance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>               sharedInstance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApplicationConversionService();
</span></span><span style="display:flex;"><span>               ApplicationConversionService.<span style="color:#a6e22e">sharedInstance</span> <span style="color:#f92672">=</span> sharedInstance;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> sharedInstance;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略一大段代码。</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="通过私有构造器强化不可实例化的能力">通过私有构造器强化不可实例化的能力<a hidden class="anchor" aria-hidden="true" href="#通过私有构造器强化不可实例化的能力">#</a></h2>
<p>像这种工具类就私有构造器。使用 final 防止继承，使用私有构造器防止实例化（开安全后防止反射实例化）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DateUtil</span>{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">DateUtil</span>(){}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>例如 spring.core 中的 String 工具类。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StringUtils</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String FOLDER_SEPARATOR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String WINDOWS_FOLDER_SEPARATOR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;\\&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String TOP_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;..&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String CURRENT_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">char</span> EXTENSION_SEPARATOR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">StringUtils</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="优先考虑依赖注入来引用资源">优先考虑依赖注入来引用资源<a hidden class="anchor" aria-hidden="true" href="#优先考虑依赖注入来引用资源">#</a></h2>
<p><em>通过依赖注入而非手动 new 对象，降低类于类之间的耦合度。而且应该尽量是基于接口而非实现来注入，这样更适合<strong>经常变更的类</strong>，或者模块</em>。当然，不是 Service 都需要写接口，除非你真的很需要，例如 SOA 程序、微服务程序，需要提供给外部 SDK。像 Spring Cloud 所有模块，以及 Spring 所定义的所有抽象一样，定义了统一的接口，引用的都是接口，而非实现类，Spring 统一的 Caching 等接口也是如此。</p>
<p>静态工具类和<code>Singleton</code>类不适合于需要引用底层资源的类。</p>
<p>关于解耦，右侧有更多解释。<a href="https://www.infoq.cn/article/8hlh2qEWP1Y00qumdMQj">细数软件架构中的解耦</a></p>
<p>集中化配置，根据服务动态解析 IP 也算是解耦的方式。</p>
<p><em style='color:blue'>当创建一个新的实例时，就将该资源传到构造器中</em></p>
<p>依赖注入（<code>Dependency Injection</code>）</p>
<p><img alt="Spring IoC" loading="lazy" src="https://i.loli.net/2021/01/11/uEgJFLlyzrk951m.png"></p>
<p>类似的内容，在进程间的 Broker 消息模式也有体现。</p>
<p>关于构造器注入好，还是 <code>Setter</code> 注入好，个人认为是前者好。<code>Spring</code>作者也推荐前者，因为这样能判断你是不是传了非空、非法的参数。</p>
<p>如果想更深入了解如何实现循环依赖，在构造器注入如何实现，可以看看 ObjectProvider，以及 Spring Boot MyBatis 的内容，那个比较简单。</p>
<p><code>Spring</code> 中单例的对象，并不一定是全局唯一的，它是 每个<code> ClassLoader</code> 中唯一的，<code>static</code> 对象也是。所以插件 Spring Dev Tool 让项目重启，只需要新的 ClassLoader 加载这些内容。这里有个小知识点，就是分级处理。和 JVM 的分代处理其实是差不多的，就是将部分不变的类用固定的 ClassLoader 加载，项目中可变的类用新的 ClassLoader 加载，这样就实现每次代码变更，不用全部重新加载的功能了。当然，这里是简化了实现细节，内部实现没有这么简单。</p>
<h2 id="避免创建不必要的对象">避免创建不必要的对象<a hidden class="anchor" aria-hidden="true" href="#避免创建不必要的对象">#</a></h2>
<ol>
<li>字符串循环累加</li>
<li>包装类型循环累加</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// DON&#39;T DO THIS面试经常问到这个，傻瓜才会这么写</span>
</span></span><span style="display:flex;"><span>String s <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String(<span style="color:#e6db74">&#34;bikini&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//正确的写法</span>
</span></span><span style="display:flex;"><span>String s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bikini&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 关于是否是罗马数字的正则校验   这样做不合理</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRomanNumeral</span>(String s){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> s.<span style="color:#a6e22e">matche</span>(<span style="color:#e6db74">&#34;^(?=.)M{1,3}?(CM|C?D|D?C{1,3})?(XC|XL|L|L?X{1,3})?(IX|I?V|V?I{1,3})?$&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 虽然String.matches方法最易于查看一个字符串是否与正则表达式相匹配，但并不适合在注重性能的情形中重复使用</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RomanNumerals</span>{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Pattern ROMAN <span style="color:#f92672">=</span> Pattern.<span style="color:#a6e22e">compile</span>(<span style="color:#e6db74">&#34;^(?=.)M{1,3}?(CM|C?D|D?C{1,3})?(XC|XL|L|L?X{1,3})?(IX|I?V|V?I{1,3})?$&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRomanNumeral</span>(String s){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ROMAN.<span style="color:#a6e22e">matcher</span>(s).<span style="color:#a6e22e">matches</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>适配器是指这样一个对象：它把功能委托给一个后备的对象（<code>backing object</code>），从而为后备对象提供一个可以代替的接口。</p>
<p><code>WebMvcConfigurerAdapter </code>这是个适配器，一般用于配置<code>web</code>的一些配置，如拦截器<code>Interceptor</code>，<code>JSONformatter</code>等，不过在<code>Java8</code>出来接口中声明 <code>default</code> 方法后，这个类就被声明 <code>@Deprecated</code>。</p>
<p><strong>优先使用基础类型而不是装箱基本类型，要当心无意识的自动装箱</strong>。(当然，实际生产中，除非你用于科学计算，一般都用包装类，例如 long 和 Long，小写的 l 容易看成大写 i 避免歧义)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 不推荐下面的写法，会让系统无意义得创建很多Long类型对象。</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sum</span>(){
</span></span><span style="display:flex;"><span>    Long sum <span style="color:#f92672">=</span> 0L;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">long</span> i <span style="color:#f92672">=</span> 0;i <span style="color:#f92672">&lt;=</span> Integer.<span style="color:#a6e22e">MAX_VALUE</span>; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//就算是一行代码，我也推荐加上大括号，语义清晰</span>
</span></span><span style="display:flex;"><span>        sum <span style="color:#f92672">+=</span> i;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> sum;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stack</span>{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">pop</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(size <span style="color:#f92672">==</span>0){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> NullPointException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Object result <span style="color:#f92672">=</span> elements<span style="color:#f92672">[--</span>size<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 把数组中对象置空，防止内存泄漏</span>
</span></span><span style="display:flex;"><span>        elements<span style="color:#f92672">[</span>size<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>内存泄漏的另一个常见来源是缓存。用<code>WeakHashMap</code>代表缓存。只有当所要的缓存项的生命周期是由该键的外部引用而不是由值决定时，<code>WeakHashMap</code>才有用处。</p>
<p>第三个常见来源是监听器和其他回调。可以借助 <code>Heap</code> 剖析工具（<code>Heap Profiler</code>）发现内存泄漏问题。</p>
<ol>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/56214714">ThreadLocal 是否存在内存泄漏问题，为什么？</a></p>
</li>
<li>
<p><a href="https://www.zhihu.com/org/a-li-yun-yun-qi-she-qu-48">阿里云云栖号</a></p>
</li>
</ol>
<h2 id="避免使用finalizer方法和java9的cleaner方法">避免使用<code>finalizer</code>方法，和<code>Java9</code>的<code>cleaner</code>方法<a hidden class="anchor" aria-hidden="true" href="#避免使用finalizer方法和java9的cleaner方法">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Room</span> <span style="color:#66d9ef">implements</span> AutoCloseable{
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Clearner cleaner <span style="color:#f92672">=</span> Cleaner.<span style="color:#a6e22e">create</span>();
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> State state;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Cleaner.<span style="color:#a6e22e">Cleanable</span> cleanable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">State</span> <span style="color:#66d9ef">implements</span> Runnable{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> numJunkPiles;
</span></span><span style="display:flex;"><span>        State(<span style="color:#66d9ef">int</span> numJunkPiles){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">numJunkPiles</span> <span style="color:#f92672">=</span> numJunkPiles;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>(){
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Cleaning room&#34;</span>);
</span></span><span style="display:flex;"><span>            numJunkPiles <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Room</span>(<span style="color:#66d9ef">int</span> numJunkPiles){
</span></span><span style="display:flex;"><span>        state <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> State(numJunkPiles);
</span></span><span style="display:flex;"><span>        cleanable <span style="color:#f92672">=</span> cleaner.<span style="color:#a6e22e">register</span>(<span style="color:#66d9ef">this</span>,state);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span>(){
</span></span><span style="display:flex;"><span>        cleanable.<span style="color:#a6e22e">clean</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="try-with-resources-优先于-try-finally">try with resources 优先于 try finally<a hidden class="anchor" aria-hidden="true" href="#try-with-resources-优先于-try-finally">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 正例</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">firstLineOfFile</span>(String path,String defualtVal){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>(BufferedReader br <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader(<span style="color:#66d9ef">new</span> FileReader(path))){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> br.<span style="color:#a6e22e">readLine</span>();
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">catch</span>(IOException e){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> defaultVal;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 反例</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">query</span>(){
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Connection conn <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    PreparedStatement pst <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    ResultSet rs <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>        conn <span style="color:#f92672">=</span> DriverManager.<span style="color:#a6e22e">getConnection</span>(<span style="color:#e6db74">&#34;com.mysql.jdbc.Driver&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// dual 表只在 Mysql 是默认有的，Oracle 查不到的</span>
</span></span><span style="display:flex;"><span>        pst <span style="color:#f92672">=</span> conn.<span style="color:#a6e22e">prepareStatement</span>(<span style="color:#e6db74">&#34;SELECT 1 FROM dual&#34;</span>);
</span></span><span style="display:flex;"><span>        pst.<span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>        rs <span style="color:#f92672">=</span> pst.<span style="color:#a6e22e">getResultSet</span>();
</span></span><span style="display:flex;"><span>        rs.<span style="color:#a6e22e">getInt</span>(0);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 老程序猿是这样教的，当然实际生产中不要这么写，尽量细化异常，让不同异常，做不同的事</span>
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">catch</span>(Exception e){
</span></span><span style="display:flex;"><span>        e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(conn <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                conn.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span>(Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(pst <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                pst.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span>(Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(rs <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                rs.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">catch</span>(Exception e){
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 这里的 logger 是 Slf4j 获取的 Logger</span>
</span></span><span style="display:flex;"><span>            logger.<span style="color:#a6e22e">error</span>(getStackTraceAsString(e));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getStackTraceAsString</span>(Throwable e) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (e <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    StringWriter stringWriter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringWriter();
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">printStackTrace</span>(<span style="color:#66d9ef">new</span> PrintWriter(stringWriter));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> stringWriter.<span style="color:#a6e22e">toString</span>()<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 1.7引入的语法糖，让代码更简洁</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// try with resource 相当于默认加了finally块，并且默认添加 finally 块，其中调用实现了 AutoCloseable 接口的 close 方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtuoCloseable 接口自 1.7 引入，让 Closeable 继承，而 Closeable @since 1.5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// InputStream &amp; OutputStream 都实现了 Closeable接口</span>
</span></span></code></pre></div><h1 id="methods-common-to-all-objects">Methods Common to All Objects<a hidden class="anchor" aria-hidden="true" href="#methods-common-to-all-objects">#</a></h1>
<h2 id="什么时候应该覆盖equals方法">什么时候应该覆盖<code>equals</code>方法？<a hidden class="anchor" aria-hidden="true" href="#什么时候应该覆盖equals方法">#</a></h2>
<p>如果类具有自己特有的“逻辑相等”（<code>logical equality</code>）概念，而且超类还没有<code>equals</code>。这通常属于”值类“（<code>Value class</code>），值类仅仅是表示一个表示值的类，例如<code>Integer</code>或<code>String</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String foo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String(<span style="color:#e6db74">&#34;str&#34;</span>);
</span></span><span style="display:flex;"><span>String bar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> String(<span style="color:#e6db74">&#34;str&#34;</span>);
</span></span><span style="display:flex;"><span>foo.<span style="color:#a6e22e">equals</span>(bar);<span style="color:#75715e">// true 比较的是对象内容，String重写了Object的equals方法</span>
</span></span><span style="display:flex;"><span>foo <span style="color:#f92672">==</span> bar ;<span style="color:#75715e">// false 比较内存地址，只要内存地址为true，就一定是一样的对象</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 还有ons-client（RocketMQ的Java client） Subscription 订阅类，覆盖了equals方法，比较的是topic，只要topic相等，这个类就相等(dump)，但是他要根据不同 tag 获取不同消息内容，比如删除 人员信息的tag和新增人员信息的 tag 不一样。搞得我以不同 tag 为基础设置类，配置半天找不到问题。</span>
</span></span></code></pre></div><p><em style='color:blue'>equals方法实现了等价关系（<code>equivalence relation</code>）</em></p>
<p>放心，在《算法》Java 版本的这本书上也有介绍，这只是个基本的概念而已。</p>
<p>&ndash; 所有前提是 对于任何非<code>null</code>的引用值<code>x</code></p>
<ul>
<li>自反性（<code>reflexive</code>）：<code>x.equals(x)</code>必须为<code>true</code></li>
<li>对称性（<code>symmetric</code>）：如果x.equals(y)==true，必定y.equals(x);前提是两个非null</li>
<li>传递性（<code>transitive</code>）：<code>x.equals(y)==true</code>,<code>y.equals(z)==true</code>,<code>z.equals(x)==true</code>;</li>
<li>一致性（<code>consistent</code>）：当<code>x.equals(y)==true</code>时，只要在比较操作在对象中所用的信息没有被修改，多次调用，都是<code>true</code>。</li>
<li>任何非<code>null</code>的引用值<code>x</code>，<code>x.equals(null)==true;</code></li>
</ul>
<p>里氏替换原则（<code>Liskov substitution principle</code>）认为，一个类型的任何重要属性也将适用于它的子类型，因此为该类型编写的任何方法，在它的子类型上也应该同样运行得很好。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@AutoValue</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutoValueMoney</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> String <span style="color:#a6e22e">getCurrency</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getAmount</span>();
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> AutoValueMoney <span style="color:#a6e22e">create</span>(String currency, <span style="color:#66d9ef">long</span> amount) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> AutoValue_AutoValueMoney(currency, amount);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AutoValue_AutoValueMoney</span> <span style="color:#66d9ef">extends</span> AutoValueMoney {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> String currency;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> amount;
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    AutoValue_AutoValueMoney(String currency, <span style="color:#66d9ef">long</span> amount) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (currency <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NullPointerException(currency);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">currency</span> <span style="color:#f92672">=</span> currency;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">amount</span> <span style="color:#f92672">=</span> amount;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hashCode</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> h <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">*=</span> 1000003;
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">^=</span> currency.<span style="color:#a6e22e">hashCode</span>();
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">*=</span> 1000003;
</span></span><span style="display:flex;"><span>        h <span style="color:#f92672">^=</span> amount;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> h;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">equals</span>(Object o) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (o <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (o <span style="color:#66d9ef">instanceof</span> AutoValueMoney) {
</span></span><span style="display:flex;"><span>            AutoValueMoney that <span style="color:#f92672">=</span> (AutoValueMoney) o;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">currency</span>.<span style="color:#a6e22e">equals</span>(that.<span style="color:#a6e22e">getCurrency</span>()))
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">amount</span> <span style="color:#f92672">==</span> that.<span style="color:#a6e22e">getAmount</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">givenValueTypeWithAutoValue_whenFieldsCorrectlySet_thenCorrect</span>() {
</span></span><span style="display:flex;"><span>    AutoValueMoney m <span style="color:#f92672">=</span> AutoValueMoney.<span style="color:#a6e22e">create</span>(<span style="color:#e6db74">&#34;USD&#34;</span>, 10000);
</span></span><span style="display:flex;"><span>    assertEquals(m.<span style="color:#a6e22e">getAmount</span>(), 10000);
</span></span><span style="display:flex;"><span>    assertEquals(m.<span style="color:#a6e22e">getCurrency</span>(), <span style="color:#e6db74">&#34;USD&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="覆盖-equals-时总要覆盖-hashcode">覆盖 equals 时总要覆盖 hashCode<a hidden class="anchor" aria-hidden="true" href="#覆盖-equals-时总要覆盖-hashcode">#</a></h2>
<ul>
<li>在应用程序的执行期间，只要对象的<code>equals</code>方法的比较操作所用到的信息没有被修改，那么对同一个对象的多次调用，<code>hashCode</code>方法必须始终放回同一个值。在一个应用程序与另一个程序的执行过程中，执行hashCode方法所返回的值可以不一致。</li>
<li>两个对象<code>equals</code>调用相等，<code>hashCode</code>一定相等</li>
<li>两个对象<code>equals</code>调用不相等，<code>hashCode</code>可以一样。例如<code>String</code>的<code>hashCode</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hashCode</span>(){			
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> h <span style="color:#f92672">=</span> hash;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (h <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span> value.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> val<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> value.<span style="color:#a6e22e">length</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            h <span style="color:#f92672">=</span> 31 <span style="color:#f92672">*</span> h <span style="color:#f92672">+</span> val<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        hash <span style="color:#f92672">=</span> h;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> h;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//选31*每个h值+每个char的值</span>
</span></span></code></pre></div><p>这是 <code>HashMap</code> 的实际的<code>put</code> 方法，里面通过</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#75715e">// 如果你是 new HashMap()创建的对象，默认这里的 resize() 大小是 16，DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4 //aka 16 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Implements Map.put and related methods.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param hash hash for key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param key the key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param value the value to put
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param onlyIfAbsent if true, don&#39;t change existing value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param evict if false, the table is in creation mode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return previous value, or null if none
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> V <span style="color:#a6e22e">putVal</span>(<span style="color:#66d9ef">int</span> hash, K key, V value, <span style="color:#66d9ef">boolean</span> onlyIfAbsent,
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">boolean</span> evict) {
</span></span><span style="display:flex;"><span>        Node<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;[]</span> tab; Node<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> p; <span style="color:#66d9ef">int</span> n, i;
</span></span><span style="display:flex;"><span>      	<span style="color:#75715e">// 第一次创建 HashMap，如果没有特殊处理，这里的 table 为 null</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((tab <span style="color:#f92672">=</span> table) <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> (n <span style="color:#f92672">=</span> tab.<span style="color:#a6e22e">length</span>) <span style="color:#f92672">==</span> 0)
</span></span><span style="display:flex;"><span>          	<span style="color:#75715e">//	也就是这里的 n = 16</span>
</span></span><span style="display:flex;"><span>            n <span style="color:#f92672">=</span> (tab <span style="color:#f92672">=</span> resize()).<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>      		<span style="color:#75715e">// 与 &amp; 操作两个操作数中位都为1，结果才为1，否则结果为0</span>
</span></span><span style="display:flex;"><span>        	<span style="color:#75715e">// 这里是判断 tab[i] 数组上有没有对象，没有直接存，跳过下面 else 复杂的步骤</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((p <span style="color:#f92672">=</span> tab<span style="color:#f92672">[</span>i <span style="color:#f92672">=</span> (n <span style="color:#f92672">-</span> 1) <span style="color:#f92672">&amp;</span> hash<span style="color:#f92672">]</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            tab<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> newNode(hash, key, value, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            Node<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> e; K k;
</span></span><span style="display:flex;"><span>          	<span style="color:#75715e">// 这里就用到 equals 来判断了</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (p.<span style="color:#a6e22e">hash</span> <span style="color:#f92672">==</span> hash <span style="color:#f92672">&amp;&amp;</span>((k <span style="color:#f92672">=</span> p.<span style="color:#a6e22e">key</span>) <span style="color:#f92672">==</span> key <span style="color:#f92672">||</span> (key <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key.<span style="color:#a6e22e">equals</span>(k))))
</span></span><span style="display:flex;"><span>                e <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (p <span style="color:#66d9ef">instanceof</span> TreeNode)
</span></span><span style="display:flex;"><span>                e <span style="color:#f92672">=</span> ((TreeNode<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span>)p).<span style="color:#a6e22e">putTreeVal</span>(<span style="color:#66d9ef">this</span>, tab, hash, key, value);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> binCount <span style="color:#f92672">=</span> 0; ; <span style="color:#f92672">++</span>binCount) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> ((e <span style="color:#f92672">=</span> p.<span style="color:#a6e22e">next</span>) <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                        p.<span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> newNode(hash, key, value, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> (binCount <span style="color:#f92672">&gt;=</span> TREEIFY_THRESHOLD <span style="color:#f92672">-</span> 1) <span style="color:#75715e">// -1 for 1st</span>
</span></span><span style="display:flex;"><span>                            treeifyBin(tab, hash);
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (e.<span style="color:#a6e22e">hash</span> <span style="color:#f92672">==</span> hash <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>                        ((k <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">key</span>) <span style="color:#f92672">==</span> key <span style="color:#f92672">||</span> (key <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> key.<span style="color:#a6e22e">equals</span>(k))))
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> e;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (e <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) { <span style="color:#75715e">// existing mapping for key</span>
</span></span><span style="display:flex;"><span>                V oldValue <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>onlyIfAbsent <span style="color:#f92672">||</span> oldValue <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>                    e.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>                afterNodeAccess(e);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> oldValue;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>modCount;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">++</span>size <span style="color:#f92672">&gt;</span> threshold)
</span></span><span style="display:flex;"><span>            resize();
</span></span><span style="display:flex;"><span>        afterNodeInsertion(evict);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h2 id="始终要覆盖tostring">始终要覆盖toString<a hidden class="anchor" aria-hidden="true" href="#始终要覆盖tostring">#</a></h2>
<p>下面是<code>Spring</code>中的抽象<code>Bean</code>定义类重写的<code>hashCode()</code>和<code>toString()</code>方法，重写<code>toString()</code>让我们能更好的<code>debug</code>以及了解这个类属性。<code>String</code>的<code>hashCode</code>是以31为优选乘子，选择相邻的质数也是<code>ok</code>的，但是<code> 31 = (2&lt;&lt;5) -1</code> ,可以被<code>JVM</code>优化。</p>
<p>{% note danger %}</p>
<p>不建议用 <code>Lombok </code>以及<code> AutoValue</code> 。代码是简洁了，维护起来很麻烦。</p>
<p>{% endnote %}</p>
<ul>
<li>你使用了这些插件，你的组员也要用，如果你在内网开发，其他人没有这个插件，完全是个灾难。</li>
<li>代码是整洁了，但是维护起来很麻烦，不要图一时之快。</li>
</ul>
<p>当然你要用，要注意用<code>@Slf4j</code>，而不是<code>@Log4j</code>，<code>SpringBoot</code>默认使用<code>Logback</code>，你指定了<code>Log4j</code>，就会有冲突，你换成其他日志输出框架，那就有问题。<code>Slf4j</code>有桥接包，屏蔽了这些内容，让你可以<code>LoggerFactory.getLogger(xxx.class)</code>，而不用明确指定是哪个日志输出框架。</p>
<p>那<code>Spring</code> 和其他框架是怎么输出日志的呢，就是用 <code>apache.logging</code>包下的<code>protected final org.apache.commons.logging.Log logger = org.apache.commons.logging.LogFactory.LogFactory.getLog(this.getClass());</code>里面的<code>getLog</code>方法，再来了<code>LogAdpter.createLog()</code>这个 <code>LogAdpter</code>里面就是去找<code>slf4j</code>或者<code>log4j</code>内容，当然你用<code>Spring Boot</code>默认的 <code>logback</code>就用<code>Slf4j</code>再来个桥接包。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LogAdapter</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOG4J_SPI <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;org.apache.logging.log4j.spi.ExtendedLogger&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOG4J_SLF4J_PROVIDER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;org.apache.logging.slf4j.SLF4JProvider&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SLF4J_SPI <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;org.slf4j.spi.LocationAwareLogger&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SLF4J_API <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;org.slf4j.Logger&#34;</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> LogAdapter.<span style="color:#a6e22e">LogApi</span> logApi;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">LogAdapter</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>下面是解析 <code>Spring</code> 中<code>AbstractBeanDefinition</code> 的 <code>toString()</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractBeanDefinition</span> <span style="color:#66d9ef">extends</span> BeanMetadataAttributeAccessor <span style="color:#66d9ef">implements</span> BeanDefinition, Cloneable {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hashCode</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> hashCode <span style="color:#f92672">=</span> ObjectUtils.<span style="color:#a6e22e">nullSafeHashCode</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getBeanClassName</span>());
</span></span><span style="display:flex;"><span>        hashCode <span style="color:#f92672">=</span> 29 <span style="color:#f92672">*</span> hashCode <span style="color:#f92672">+</span> ObjectUtils.<span style="color:#a6e22e">nullSafeHashCode</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">scope</span>);
</span></span><span style="display:flex;"><span>        hashCode <span style="color:#f92672">=</span> 29 <span style="color:#f92672">*</span> hashCode <span style="color:#f92672">+</span> ObjectUtils.<span style="color:#a6e22e">nullSafeHashCode</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">constructorArgumentValues</span>);
</span></span><span style="display:flex;"><span>        hashCode <span style="color:#f92672">=</span> 29 <span style="color:#f92672">*</span> hashCode <span style="color:#f92672">+</span> ObjectUtils.<span style="color:#a6e22e">nullSafeHashCode</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">propertyValues</span>);
</span></span><span style="display:flex;"><span>        hashCode <span style="color:#f92672">=</span> 29 <span style="color:#f92672">*</span> hashCode <span style="color:#f92672">+</span> ObjectUtils.<span style="color:#a6e22e">nullSafeHashCode</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">factoryBeanName</span>);
</span></span><span style="display:flex;"><span>        hashCode <span style="color:#f92672">=</span> 29 <span style="color:#f92672">*</span> hashCode <span style="color:#f92672">+</span> ObjectUtils.<span style="color:#a6e22e">nullSafeHashCode</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">factoryMethodName</span>);
</span></span><span style="display:flex;"><span>        hashCode <span style="color:#f92672">=</span> 29 <span style="color:#f92672">*</span> hashCode <span style="color:#f92672">+</span> <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">hashCode</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> hashCode;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span>() {
</span></span><span style="display:flex;"><span>        StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder(<span style="color:#e6db74">&#34;class [&#34;</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getBeanClassName</span>()).<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;]&#34;</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; scope=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">scope</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; abstract=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">abstractFlag</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; lazyInit=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lazyInit</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; autowireMode=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">autowireMode</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; dependencyCheck=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dependencyCheck</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; autowireCandidate=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">autowireCandidate</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; primary=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">primary</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; factoryBeanName=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">factoryBeanName</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; factoryMethodName=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">factoryMethodName</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; initMethodName=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">initMethodName</span>);
</span></span><span style="display:flex;"><span>        sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; destroyMethodName=&#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">destroyMethodName</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resource</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            sb.<span style="color:#a6e22e">append</span>(<span style="color:#e6db74">&#34;; defined in &#34;</span>).<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">getDescription</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sb.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="谨慎地覆盖-clone">谨慎地覆盖 clone<a hidden class="anchor" aria-hidden="true" href="#谨慎地覆盖-clone">#</a></h2>
<p><strong>不可变的类永远都不应该提供<code>clone</code>方法</strong></p>
<p>实际上<code>clone</code>方法就是另一个构造器，必须确保它不会伤害到原始的对象，并确保正确地创建被克隆对象中的约束条件（<code>invariant</code>）。</p>
<p><code>Cloneable</code>架构与引用可变对象的final域的正常用法是不相兼容的。</p>
<p><code>HashMap.Entry</code>被加强了，它支持一个“深拷贝”<code>deepCopy()</code>;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">clone</span>() {
</span></span><span style="display:flex;"><span>    HashMap<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> result;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> (HashMap<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span>)<span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">clone</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (CloneNotSupportedException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// this shouldn&#39;t happen, since we are Cloneable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InternalError(e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    result.<span style="color:#a6e22e">reinitialize</span>();
</span></span><span style="display:flex;"><span>    result.<span style="color:#a6e22e">putMapEntries</span>(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><a href="https://mp.weixin.qq.com/s/K0_FBX6pRJ-seUGKVqrY-w">什么是深拷贝，什么是浅拷贝</a></p>
<p><code>Java Shallow clone</code></p>
<p><strong>Shallow clone</strong> is  default implementation  in Java. In overridden <code>clone</code> method, if you are not cloning all the object types (not primitives（原生类型）, then you are making a shallow copy.</p>
<p><code>Java Deep Copy</code></p>
<p>In the deep copy, we create a clone which is independent of original object and making changes in the cloned object should not affect original object.</p>
<h2 id="考虑实现-comparable-接口">考虑实现 Comparable 接口<a hidden class="anchor" aria-hidden="true" href="#考虑实现-comparable-接口">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Comparable</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compareTo</span>(T t);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>返回值规范</p>
<pre tabindex="0"><code class="language-code" data-lang="code">this &lt; t =&gt; -1，

this == t =&gt; 0;

this &gt; t =&gt; 1;
</code></pre><p>遵循下面几个规范</p>
<ul>
<li>sgn(x.compareTo(y)) == -sgn(y.compareTo(x));  类似1 == -(-1)</li>
<li>传递性，a&gt;b,b&gt;c     =&gt;   a&gt;c</li>
<li>如果x.compareTo(y) ==0，sgn(x.compareTo(z)) == sgn(y.compareTo(z))。a==b,a.f(c) == b.f(c)</li>
</ul>
<p>强烈建议<code> x 比 y == 0</code>，<code>x.equals(y) =&gt; true</code>,若违反了这个条件，都应该明确说明。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>BigDecimal foo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BigDecimal(<span style="color:#e6db74">&#34;1.0&#34;</span>);
</span></span><span style="display:flex;"><span>BigDecimal bar <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BigDecimal(<span style="color:#e6db74">&#34;1.00&#34;</span>);
</span></span><span style="display:flex;"><span>foo.<span style="color:#a6e22e">equals</span>(bar);<span style="color:#75715e">//false</span>
</span></span><span style="display:flex;"><span>foo.<span style="color:#a6e22e">compareTo</span>(bar);<span style="color:#75715e">// 0	值相等</span>
</span></span></code></pre></div><p><em style="color:blue">在ocmpareTo方法中使用关系操作符 &lt; 和 &gt; 是非常繁琐的，而且容易出错，因此不建议使用</em></p>
<p>HashSet 会两个都存，TreeSet 只会存一个，因为利用了compareTo() 方法。
实现 Comparable 接口，有助于在有序集合中更好的排序。</p>
<h1 id="classes-and-interfaces">Classes and Interfaces<a hidden class="anchor" aria-hidden="true" href="#classes-and-interfaces">#</a></h1>
<h2 id="使类和成员的可访问性最小化">使类和成员的可访问性最小化<a hidden class="anchor" aria-hidden="true" href="#使类和成员的可访问性最小化">#</a></h2>
<p>区分一个组件设计得好不好，唯一重要的因素在于，它对外部的其他组件而言，是否隐藏了其内部数据和其他实现细节。设计良好的组件会隐藏所有的实现细节，把<code>API</code>与实现清晰地隔离开来。然后组件之间通过<code>API</code>通信，一个模块不需要知道其他模块的内部工作情况。这个概念被称为信息隐藏（<code>information hiding</code>）/封装（<code>encapsulation</code>），是软件设计的基本原则之一。</p>
<p>例如<code>Spring Boot 2.0</code>后的版本的<code>Spring Boot</code>，直接在<code>https://start.spring.io</code>直接生成就完事了，不像以前写一个<code>Web</code>应用先要<code>Servlet</code> 容器（<code>Tomcat/Jetty/Weblogic</code>等），再实现<code>javax.servlet.http.HttpServlet</code>重写它的<code>doGet/doPost</code>方法，甚至是<code>service</code>方法（不建议这么做，有关内容自己谷歌 <code>Http Code 304</code>），然后在 <code>web.xml</code>文件中添加这么一坨东西。</p>
<p>{% tabs content-1 %}</p>
<!-- tab Java代码部分 -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Import required java libraries</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Extend HttpServlet class</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloWorld</span> <span style="color:#66d9ef">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doGet</span>(HttpServletRequest request, HttpServletResponse response)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        String message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hello World&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Set response content type</span>
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">setContentType</span>(<span style="color:#e6db74">&#34;text/html&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Actual logic goes here.</span>
</span></span><span style="display:flex;"><span>        PrintWriter out <span style="color:#f92672">=</span> response.<span style="color:#a6e22e">getWriter</span>();
</span></span><span style="display:flex;"><span>        out.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;&lt;h1&gt;&#34;</span> <span style="color:#f92672">+</span> message <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&lt;/h1&gt;&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><!-- endtab -->
<!-- tab web.xml部分 -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;servlet&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;servlet-name&gt;</span>HelloWorld<span style="color:#f92672">&lt;/servlet-name&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;servlet-class&gt;</span>me.young1lin.HelloWorld<span style="color:#f92672">&lt;/servlet-class&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/servlet&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;servlet-mapping&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;servlet-name&gt;</span>HelloWorld<span style="color:#f92672">&lt;/servlet-name&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;url-pattern&gt;</span>/HelloWorld<span style="color:#f92672">&lt;/url-pattern&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/servlet-mapping&gt;</span>
</span></span></code></pre></div><!-- endtab -->
<!-- tab 有关 304 在HttpServlet及Servlet容器的实现 -->
<p><img alt="Http Code 304.png" loading="lazy" src="https://i.loli.net/2020/07/09/1cwSl6KMXNrVtY7.png"></p>
<!-- endtab -->
<p>{% endtabs %}</p>
<p><a href="https://www.tutorialspoint.com/servlets/servlets-first-example.htm">引用</a></p>
<p>当然这些东西不算完，还要放进<code>Servlet</code>容器中启动，最终返回信息。</p>
<p>而<code>Spring Boot</code>只需要简单几行代码的配置，就能启动一个<code>web</code>应用。</p>
<p>信息隐藏之所以重要，是因为</p>
<ol>
<li>有效地解除组成系统的各组件之间的耦合关系，即解耦（<code>decouple</code>），使得这些组件可以独立地开发、测试、优化、使用、理解和修改。</li>
<li>同时减轻了维护的负担。</li>
<li>隐藏实现，就可以使代码组件化，如果因为哪个组件性能差，就可以单独对这个组件进行优化。</li>
</ol>
<p>{% note info %}</p>
<p>尽可能地使每个类或者成员不被外界访问</p>
<p>{% endnote %}</p>
<p>并且一个包级私有的顶层类（或者接口）只是在某一个类的内部被用到，就应该考虑使它成为唯一使用它的那个累的私有嵌套类（内部类）。像下面这样</p>
<p>{% tabs content-2 %}</p>
<!-- tab HashMap Node部分 -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> AbstractMap<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">implements</span> Map<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span>, Cloneable, Serializable {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//.....省略一大段代码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> Map.<span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> hash;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> K key;
</span></span><span style="display:flex;"><span>        V value;
</span></span><span style="display:flex;"><span>        Node<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> next;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Node(<span style="color:#66d9ef">int</span> hash, K key, V value, Node<span style="color:#f92672">&lt;</span>K,V<span style="color:#f92672">&gt;</span> next) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hash</span> <span style="color:#f92672">=</span> hash;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> key;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">next</span> <span style="color:#f92672">=</span> next;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> K <span style="color:#a6e22e">getKey</span>()        { <span style="color:#66d9ef">return</span> key; }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> V <span style="color:#a6e22e">getValue</span>()      { <span style="color:#66d9ef">return</span> value; }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> String <span style="color:#a6e22e">toString</span>() { <span style="color:#66d9ef">return</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;=&#34;</span> <span style="color:#f92672">+</span> value; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hashCode</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Objects.<span style="color:#a6e22e">hashCode</span>(key) <span style="color:#f92672">^</span> Objects.<span style="color:#a6e22e">hashCode</span>(value);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> V <span style="color:#a6e22e">setValue</span>(V newValue) {
</span></span><span style="display:flex;"><span>            V oldValue <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> newValue;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> oldValue;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">equals</span>(Object o) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (o <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (o <span style="color:#66d9ef">instanceof</span> Map.<span style="color:#a6e22e">Entry</span>) {
</span></span><span style="display:flex;"><span>                Map.<span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;?</span>,<span style="color:#f92672">?&gt;</span> e <span style="color:#f92672">=</span> (Map.<span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;?</span>,<span style="color:#f92672">?&gt;</span>)o;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (Objects.<span style="color:#a6e22e">equals</span>(key, e.<span style="color:#a6e22e">getKey</span>()) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>                    Objects.<span style="color:#a6e22e">equals</span>(value, e.<span style="color:#a6e22e">getValue</span>()))
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><!-- endtab -->
<!-- tab ArrayList 迭代器部分 -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ArrayList</span><span style="color:#f92672">&lt;</span>E<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">extends</span> AbstractList<span style="color:#f92672">&lt;</span>E<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">implements</span> List<span style="color:#f92672">&lt;</span>E<span style="color:#f92672">&gt;</span>, RandomAccess, Cloneable, java.<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Serializable</span>
</span></span><span style="display:flex;"><span>{    
</span></span><span style="display:flex;"><span>  		<span style="color:#75715e">// ......省略一大段代码</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Itr</span> <span style="color:#66d9ef">implements</span> Iterator<span style="color:#f92672">&lt;</span>E<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> cursor;       <span style="color:#75715e">// index of next element to return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> lastRet <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1; <span style="color:#75715e">// index of last element returned; -1 if no such</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> expectedModCount <span style="color:#f92672">=</span> modCount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Itr() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasNext</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> cursor <span style="color:#f92672">!=</span> size;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@SuppressWarnings</span>(<span style="color:#e6db74">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> E <span style="color:#a6e22e">next</span>() {
</span></span><span style="display:flex;"><span>            checkForComodification();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> cursor;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> size)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoSuchElementException();
</span></span><span style="display:flex;"><span>            Object<span style="color:#f92672">[]</span> elementData <span style="color:#f92672">=</span> ArrayList.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">elementData</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> elementData.<span style="color:#a6e22e">length</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConcurrentModificationException();
</span></span><span style="display:flex;"><span>            cursor <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> 1;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (E) elementData<span style="color:#f92672">[</span>lastRet <span style="color:#f92672">=</span> i<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (lastRet <span style="color:#f92672">&lt;</span> 0)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException();
</span></span><span style="display:flex;"><span>            checkForComodification();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                ArrayList.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">remove</span>(lastRet);
</span></span><span style="display:flex;"><span>                cursor <span style="color:#f92672">=</span> lastRet;
</span></span><span style="display:flex;"><span>                lastRet <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1;
</span></span><span style="display:flex;"><span>                expectedModCount <span style="color:#f92672">=</span> modCount;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (IndexOutOfBoundsException ex) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConcurrentModificationException();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@SuppressWarnings</span>(<span style="color:#e6db74">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">forEachRemaining</span>(Consumer<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> E<span style="color:#f92672">&gt;</span> consumer) {
</span></span><span style="display:flex;"><span>            Objects.<span style="color:#a6e22e">requireNonNull</span>(consumer);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> ArrayList.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">size</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> cursor;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> size) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> Object<span style="color:#f92672">[]</span> elementData <span style="color:#f92672">=</span> ArrayList.<span style="color:#a6e22e">this</span>.<span style="color:#a6e22e">elementData</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> elementData.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConcurrentModificationException();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (i <span style="color:#f92672">!=</span> size <span style="color:#f92672">&amp;&amp;</span> modCount <span style="color:#f92672">==</span> expectedModCount) {
</span></span><span style="display:flex;"><span>                consumer.<span style="color:#a6e22e">accept</span>((E) elementData<span style="color:#f92672">[</span>i<span style="color:#f92672">++]</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// update once at end of iteration to reduce heap write traffic</span>
</span></span><span style="display:flex;"><span>            cursor <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>            lastRet <span style="color:#f92672">=</span> i <span style="color:#f92672">-</span> 1;
</span></span><span style="display:flex;"><span>            checkForComodification();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkForComodification</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (modCount <span style="color:#f92672">!=</span> expectedModCount)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConcurrentModificationException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><!-- endtab -->
<p>{% endtabs %}</p>
<p>公有类的实例域决不能是公有的，包含公有可变域的类通常并不是线程安全的。</p>
<p>虽然 ClassPathXmlApplicationContext 封装做的很好，但是学习起来比较费劲。</p>
<h2 id="使可变性最小化">使可变性最小化<a hidden class="anchor" aria-hidden="true" href="#使可变性最小化">#</a></h2>
<p>善用<code>final</code>、加上<code>final</code>的静态工厂，享元模式。<code>BigDecimal.ZERO</code>，<code>Integer</code>的自动拆装箱里面的<code>CacheInteger</code>类。</p>
<h2 id="复合优于继承">复合优于继承<a hidden class="anchor" aria-hidden="true" href="#复合优于继承">#</a></h2>
<p>我觉得更优的翻译应该叫组合优于继承。当然，不是所有情况下都要用组合。《UNIX 编程艺术》中也提到，善用组合。</p>
<p>下面是 <code>Spring</code> 基石 <code>GenericApplicationContext</code> 中的源码，其中 <code>DefaultListableBeanFactory</code> 才是真正的容器。这个叫组合模式，两者都实现了同一个接口（<code>BeanFactory</code>），这里的 <code>DefaultListableBeanFactory</code> 可以是一个至多个，然后依次调用，直到返回结果为止。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GenericApplicationContext</span> <span style="color:#66d9ef">extends</span> AbstractApplicationContext <span style="color:#66d9ef">implements</span> BeanDefinitionRegistry{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> DefaultListableBeanFactory beanFactory;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略一大段代码</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> ConfigurableListableBeanFactory <span style="color:#a6e22e">getBeanFactory</span>() {
</span></span><span style="display:flex;"><span>   		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanFactory</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// .....省略一段代码</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>用内含的方式实现，例如<code>JFinal</code>中的<code>Record</code>对象，内含了一个<code>HashMap</code>对象，来实现一些操作。万物(单条数据)皆为<code>Record</code>。</p>
<p>Spring 中 ApplicationContext 类型的对象就是内涵了个 BeanFactory，其实就是 DefaultListableBeanFactory，也就是所谓的 IoC （Inversion of Control）容器。</p>
<h2 id="要么设计继承并提供文档说明要么禁止继承">要么设计继承并提供文档说明，要么禁止继承<a hidden class="anchor" aria-hidden="true" href="#要么设计继承并提供文档说明要么禁止继承">#</a></h2>
<p>类必须精心挑选的受保护的（<code>protected</code>）方法，提供适当的钩子（<code>hook</code>），一边进入其内部工作中。</p>
<p>因为要符合里氏替换原则，之后开发的人，并不清楚你现在的类是什么意思。</p>
<h2 id="接口优于抽象类">接口优于抽象类<a hidden class="anchor" aria-hidden="true" href="#接口优于抽象类">#</a></h2>
<p>类是单继承，接口可以多实现，多接口可以实现不同业务需求，由于<code>1.8</code>后可以用<code>default</code>修饰接口方法，实现和抽象类一样的效果，又可以有实体方法，又有待子类实现的抽象方法。</p>
<p>Netty 中的 ChannelInboundHandler 就是个很好的例子。</p>
<p>多个接口方法同名，实现类报错</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">A</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">f</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">B</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span> <span style="color:#66d9ef">implements</span> A,B{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">f</span>();<span style="color:#75715e">// 这样会报错，不知道你到底要返回什么类型，但是把B的void改成int，就不会报错</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接口是高度抽象的结果，而抽象类</p>
<h2 id="为后代设计接口">为后代设计接口<a hidden class="anchor" aria-hidden="true" href="#为后代设计接口">#</a></h2>
<p>慎用 default 去修饰接口方法</p>
<p>BeanFactory 接口定义了最基本的容器功能。</p>
<h2 id="接口只用于定义类型">接口只用于定义类型<a hidden class="anchor" aria-hidden="true" href="#接口只用于定义类型">#</a></h2>
<p>常量接口模式是对接口的不良使用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">XXXConstants</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String MY_CONSTANTS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my constants    &#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>java.io.ObjectStreamConstants</code> 是个反例</p>
<p>如果要去定义常量</p>
<ol>
<li>
<p>要么在类内部定义，想 <code>Integer.MAX_VALUE</code>，<code>BigDecimal.ZERO</code>等等</p>
</li>
<li>
<p>要么用枚举实现，像我自定义的状态信息</p>
</li>
</ol>
<p>接口应该用来定义类型。</p>
<h2 id="类层次优先于标签类">类层次优先于标签类<a hidden class="anchor" aria-hidden="true" href="#类层次优先于标签类">#</a></h2>
<p>字面意思。</p>
<p>像这种 <code>AbstractApplicationContext</code> 继承自 <code>DefaultResourceLoader</code>，拥有了资源加载的能力，像 EventObject 这种就是标记类，你可以加上，也可以不加，但是这是约定俗称的事件对象的类。</p>
<p>著名的标签接口（tagging interface）<code>java.util.EventListener</code>、<code>java.lang.Serializable</code>。注意这里是接口，平常项目开发也是会自己定义标记接口的，里面没有任何方法（行为），仅起到标记作用。这个是约定俗称的内容，你不遵守，等待的就是报错（例如 Java 序列化没有实现 Serializable 接口，就会报错）。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * A tagging interface that all event listener interfaces must extend.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @since JDK1.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">EventListener</span> {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="静态成员类优先于非静态成员类">静态成员类优先于非静态成员类<a hidden class="anchor" aria-hidden="true" href="#静态成员类优先于非静态成员类">#</a></h2>
<p><code>Builder</code></p>
<p><code>Map.Entry</code></p>
<h2 id="限制源文件为单个顶级类public-修饰与文件名相同的类">限制源文件为单个顶级类(<code>public</code> 修饰与文件名相同的类)<a hidden class="anchor" aria-hidden="true" href="#限制源文件为单个顶级类public-修饰与文件名相同的类">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pan&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cake&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 两个不同文件，public 修饰的 class 为该文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bar&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">A</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">C</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args){
</span></span><span style="display:flex;"><span>        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(A.<span style="color:#a6e22e">NAME</span><span style="color:#f92672">+</span>B.<span style="color:#a6e22e">NAME</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样有歧义，编译不给过，分开存。如果一定要放一起，就放在顶级类内部做静态成员类。</p>
<h1 id="generics">Generics<a hidden class="anchor" aria-hidden="true" href="#generics">#</a></h1>
<p>翻译版本有误，<code>SINCE Java 5, generics have been a part of the language</code>. 翻译版本少了个 s 变成了 generic。因为 Think in Java 英文版中， generics 才是代表泛型。</p>
<h2 id="不要使用原生态类型">不要使用原生态类型<a hidden class="anchor" aria-hidden="true" href="#不要使用原生态类型">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 别这样使用，报黄线是结果，原因是没有确定类型，那么就是任何类型都可以存入，如果存错了东西，取出来强制转换的时候，会报错。编译时给不了提示。</span>
</span></span><span style="display:flex;"><span>List apples <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList(1<span style="color:#f92672">&lt;&lt;</span>4);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 应该这样用，编译器就会告诉你哪里出问题</span>
</span></span><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Apple<span style="color:#f92672">&gt;</span> apples <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList (1<span style="color:#f92672">&lt;&lt;</span>4);
</span></span><span style="display:flex;"><span>apples.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">new</span> Banana());
</span></span><span style="display:flex;"><span><span style="color:#75715e">//如果 Banana不是继承 Apple，就会报错</span>
</span></span><span style="display:flex;"><span>  
</span></span></code></pre></div><p><code>List</code> 和 <code>List&lt;Object&gt;</code> 是有区别的，后者明确告诉该容器接受所有任意类型对象。</p>
<p>必须在类文字（<code>class literal</code>）中使用原生态类型</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger log <span style="color:#f92672">=</span> LoggerFactory.<span style="color:#a6e22e">getLogger</span>(User.<span style="color:#a6e22e">class</span>);
</span></span></code></pre></div><h2 id="消除非受检的警告">消除非受检的警告<a hidden class="anchor" aria-hidden="true" href="#消除非受检的警告">#</a></h2>
<p><code>/uncheck/</code></p>
<p>⬆️尽量不要编译后出现这个（其实就是<code>@SuppreWarnings(&quot;unchecked&quot;)</code>），除非可以证明引起警告的代码是类型安全的，用 /uncheck/ 或者 <code>@SuppreWarnings(&quot;unchecked&quot;)</code>来禁止警告。尽可能在小的范围使用这个注解，像 <code>synchronized</code> 以及<code> catch Exception</code> 一样，尽可能精准，细粒度去做。这样好调试啊。</p>
<p>书上讲的 <code>ArrayList.toArray(T[] a)</code>方法，在 <code>JDK1.8</code> 中，源码是把去警告的注解放在方法上的，和他推荐的不一样。当然还是按照作者推荐的，这样让后人更容易懂你写的代码，尽量别写出祖传代码.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@SuppressWarnings</span>(<span style="color:#e6db74">&#34;unchecked&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T<span style="color:#f92672">[]</span> <span style="color:#a6e22e">toArray</span>(T<span style="color:#f92672">[]</span> a) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (a.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> size)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Make a new array of a&#39;s runtime type, but my contents:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (T<span style="color:#f92672">[]</span>) Arrays.<span style="color:#a6e22e">copyOf</span>(elementData, size, a.<span style="color:#a6e22e">getClass</span>());
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">arraycopy</span>(elementData, 0, a, 0, size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (a.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> size)
</span></span><span style="display:flex;"><span>        a<span style="color:#f92672">[</span>size<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="列表优先于数组">列表优先于数组<a hidden class="anchor" aria-hidden="true" href="#列表优先于数组">#</a></h2>
<p>除非写游戏类的，用二维数组表示坐标什么的，科学计算用基础类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 编译不报错，运行报错</span>
</span></span><span style="display:flex;"><span>Object<span style="color:#f92672">[]</span> o <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Long<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>objectArray<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;str&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 编译报错</span>
</span></span><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> o2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>ol.<span style="color:#a6e22e">add</span>(<span style="color:#e6db74">&#34;str&#34;</span>);
</span></span></code></pre></div><p>范型数组不存在，编译不通过。</p>
<p>列表帮你做好了动态扩容，类型转换等操作。</p>
<h2 id="优先考虑范型">优先考虑范型<a hidden class="anchor" aria-hidden="true" href="#优先考虑范型">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 以前写 BaseDao 这种类时写的反射方法，也是 ORM 框架中会用到的方法。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">query</span>(Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> clazz);
</span></span></code></pre></div><h2 id="优先考虑范型方法-">优先考虑范型方法 ⬆️<a hidden class="anchor" aria-hidden="true" href="#优先考虑范型方法-">#</a></h2>
<p>像上面这种</p>
<p>善用通配符，<code>E Element</code>，<code>T type</code>表示具体的类型，<code>K V key Value</code>，？ 不确定什么类型</p>
<p><code>JDK1.7</code>引入<code>@SafeVarargs</code> 放在方法上，消除使用范型方法警告</p>
<h2 id="利用有限制通配符来提升-api-的灵活性">利用有限制通配符来提升 <code>API</code> 的灵活性<a hidden class="anchor" aria-hidden="true" href="#利用有限制通配符来提升-api-的灵活性">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>T <span style="color:#66d9ef">extends</span> Record<span style="color:#f92672">&gt;</span> list;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isContainAnnotation</span>(Object target,Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Annotation<span style="color:#f92672">&gt;</span> clazz){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">==</span> target.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getAnnotation</span>(clazz);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="谨慎使用并用范型和可变参数">谨慎使用并用范型和可变参数<a hidden class="anchor" aria-hidden="true" href="#谨慎使用并用范型和可变参数">#</a></h2>
<p>《阿里巴巴 Java 开发规范》中也明确指出了，少用甚至不用可变参数，这是个语法糖。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">foo</span>(List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span>...  stringLists)<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这样一起用，就要谨慎了。不安全，当遇到不同类型转换时，编译器不能把你的错误给指出来。</span>
</span></span></code></pre></div><p>如果真的方法是安全的，对于每一个带有范型可变参数或者参数化类型的方法，都要用<code>@SafeVarargs</code>进行注解.</p>
<h2 id="优先考虑类型安全的异构容器">优先考虑类型安全的异构容器<a hidden class="anchor" aria-hidden="true" href="#优先考虑类型安全的异构容器">#</a></h2>
<p>以前写的手动分页的类。,<code>List&lt;E&gt; Set&lt;E&gt; Map&lt;K,V&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Page</span><span style="color:#f92672">&lt;</span>E<span style="color:#f92672">&gt;</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> index; 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> size<span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> E<span style="color:#f92672">[]</span> list;
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">//.... getter setter</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="enums-and-annotations">Enums and Annotations<a hidden class="anchor" aria-hidden="true" href="#enums-and-annotations">#</a></h1>
<h2 id="用-enum-代替-int-常量">用 enum 代替 int 常量<a hidden class="anchor" aria-hidden="true" href="#用-enum-代替-int-常量">#</a></h2>
<p><code>Java</code> 的枚举本质上是<code> int</code> 值。<code>《深入理解 Java 虚拟机》</code>介绍了枚举类其实是隐式继承了 <code>java.lang.Enum</code>这个类，所以枚举不能继承其他类，只能实现接口。</p>
<p>Java enums can extend <strong>java.lang.Enum</strong> class <strong>implicitly</strong>（隐含的）, so enum types cannot extend another class.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SomeThingStatus</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> Y <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> N <span style="color:#f92672">=</span> 0;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 用枚举替代</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> Status{
</span></span><span style="display:flex;"><span>    Y,N
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>根据枚举所作用的范围，尽可能贴合实际使用范围来定义枚举类该在类私有/包级私有/顶层类（<code>top-level class</code>）/顶层类的成员类。</p>
<p>策略模式枚举</p>
<p><code>trategy enum</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> PayrollDay{
</span></span><span style="display:flex;"><span>    MONDAY,TUESEDAY,WEDNESDAY,THURSDAY,FRIDAY,SATURDAY(PayType.<span style="color:#a6e22e">WEEKEND</span>),SUNDAY(PayType.<span style="color:#a6e22e">WEEKEND</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> PayType payType;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PayrollDay(PayType paytype){<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">payType</span> <span style="color:#f92672">=</span> payType;}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PayrollDay(){<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>(PayType.<span style="color:#a6e22e">WEEKDAY</span>);}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pay</span> (<span style="color:#66d9ef">int</span> minutesWorked, <span style="color:#66d9ef">int</span> payRate){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> payType.<span style="color:#a6e22e">pay</span>(minutesWorked, payRate);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">enum</span> PayType{
</span></span><span style="display:flex;"><span>        WEEKDAY{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">overtimePay</span>(<span style="color:#66d9ef">int</span> minsWorked, <span style="color:#66d9ef">int</span> payRate){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> minisWorked <span style="color:#f92672">&lt;=</span> MINIS_PER_SHIT <span style="color:#f92672">?</span> 0 : (minsWorked <span style="color:#f92672">-</span> NINS_PER_SHIFT) <span style="color:#f92672">*</span> payRate <span style="color:#f92672">/</span> 2;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        WEEKEND{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">overtimePay</span>(<span style="color:#66d9ef">int</span> minsWorked, <span style="color:#66d9ef">int</span> payRate){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> minsWorked <span style="color:#f92672">*</span> payRate <span style="color:#f92672">/</span> 2;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">overtimePay</span>(<span style="color:#66d9ef">int</span> mins,<span style="color:#66d9ef">int</span> payRate);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MINIS_PER_SHIFT <span style="color:#f92672">=</span> 8 <span style="color:#f92672">*</span> 60;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pay</span>(<span style="color:#66d9ef">int</span> minsWorked, <span style="color:#66d9ef">int</span> payRate){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> basePay <span style="color:#f92672">=</span> minsWorked <span style="color:#f92672">*</span> payRate;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> basePay <span style="color:#f92672">+</span> overtimePay(minsWorked, payRate);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>每当需要一组固定的常量，并且在编译时就知道其成员的时候，就应该使用枚举。如菜单的选项、操作代码以及命令行标记等。</p>
<p>策略模式 如 <code>org.springframework.core.io.Resource</code></p>
<ul>
<li>**UrlResource：**访问网络资源的实现类。</li>
<li>**ClassPathResource：**访问类加载路径里资源的实现类。</li>
<li>**FileSystemResource：**访问文件系统里资源的实现类。</li>
<li>**ServletContextResource：**访问相对于 ServletContext 路径里的资源的实现类.</li>
<li>**InputStreamResource：**访问输入流资源的实现类。</li>
<li>**ByteArrayResource：**访问字节数组资源的实现类。</li>
</ul>
<p>责任链模式，例如 Handler Interceptor，Filter 。如下所示：</p>
<p>DispatcherServlet 中的 service 方法，经过一些校验和一些参数设置，最终会调用这个方法，如果你懂了这个方法，Spring MVC 一般的情况都能 Hold 住了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doDispatch</span>(HttpServletRequest request, HttpServletResponse response) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    HttpServletRequest processedRequest <span style="color:#f92672">=</span> request;
</span></span><span style="display:flex;"><span>    HandlerExecutionChain mappedHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span> multipartRequestParsed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    WebAsyncManager asyncManager <span style="color:#f92672">=</span> WebAsyncUtils.<span style="color:#a6e22e">getAsyncManager</span>(request);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            ModelAndView mv <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>            Object dispatchException <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                processedRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checkMultipart</span>(request);
</span></span><span style="display:flex;"><span>                multipartRequestParsed <span style="color:#f92672">=</span> processedRequest <span style="color:#f92672">!=</span> request;
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// HandlerMapping 会在系统启动的时候，把所有的 RequestMapping 相关的方法封装成 MethodHadler，注入进来</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 先从 HandlerMapping 中获取对应的 Handler</span>
</span></span><span style="display:flex;"><span>                mappedHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getHandler</span>(processedRequest);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (mappedHandler <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">noHandlerFound</span>(processedRequest, response);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                HandlerAdapter ha <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getHandlerAdapter</span>(mappedHandler.<span style="color:#a6e22e">getHandler</span>());
</span></span><span style="display:flex;"><span>                String method <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getMethod</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">boolean</span> isGet <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GET&#34;</span>.<span style="color:#a6e22e">equals</span>(method);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 做一些优化，304 方面的。看文件没有没改动过，没有就直接返回请求。</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (isGet <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;HEAD&#34;</span>.<span style="color:#a6e22e">equals</span>(method)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">long</span> lastModified <span style="color:#f92672">=</span> ha.<span style="color:#a6e22e">getLastModified</span>(request, mappedHandler.<span style="color:#a6e22e">getHandler</span>());
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">new</span> ServletWebRequest(request, response)).<span style="color:#a6e22e">checkNotModified</span>(lastModified) <span style="color:#f92672">&amp;&amp;</span> isGet) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// mapperHandler，执行 preHandle 方法。对应 Interceptor preHandle 的方法</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mappedHandler.<span style="color:#a6e22e">applyPreHandle</span>(processedRequest, response)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                mv <span style="color:#f92672">=</span> ha.<span style="color:#a6e22e">handle</span>(processedRequest, response, mappedHandler.<span style="color:#a6e22e">getHandler</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (asyncManager.<span style="color:#a6e22e">isConcurrentHandlingStarted</span>()) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">applyDefaultViewName</span>(processedRequest, mv);
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 对应 Intercaptor 的 postHandler 方法。</span>
</span></span><span style="display:flex;"><span>                mappedHandler.<span style="color:#a6e22e">applyPostHandle</span>(processedRequest, response, mv);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception var20) {
</span></span><span style="display:flex;"><span>                dispatchException <span style="color:#f92672">=</span> var20;
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Throwable var21) {
</span></span><span style="display:flex;"><span>                dispatchException <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NestedServletException(<span style="color:#e6db74">&#34;Handler dispatch failed&#34;</span>, var21);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">processDispatchResult</span>(processedRequest, response, mappedHandler, mv, (Exception)dispatchException);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception var22) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">triggerAfterCompletion</span>(processedRequest, response, mappedHandler, var22);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Throwable var23) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">triggerAfterCompletion</span>(processedRequest, response, mappedHandler, <span style="color:#66d9ef">new</span> NestedServletException(<span style="color:#e6db74">&#34;Handler processing failed&#34;</span>, var23));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (asyncManager.<span style="color:#a6e22e">isConcurrentHandlingStarted</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (mappedHandler <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                mappedHandler.<span style="color:#a6e22e">applyAfterConcurrentHandlingStarted</span>(processedRequest, response);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (multipartRequestParsed) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cleanupMultipart</span>(processedRequest);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="用实例域代替序数表示次序的数目">用实例域代替序数（表示次序的数目）<a hidden class="anchor" aria-hidden="true" href="#用实例域代替序数表示次序的数目">#</a></h2>
<p>实例域 <code>ONE(1),TWO(2)</code></p>
<h2 id="用-enumset-代替位域">用 EnumSet 代替位域<a hidden class="anchor" aria-hidden="true" href="#用-enumset-代替位域">#</a></h2>
<p>让你用 <code>OR</code> 位运算将几个常量合并到一个集合中，称作位域（<code>bit field</code>）</p>
<p><code>Set set = EnumSet.of(ONE,TWO);  </code></p>
<h2 id="用-enummap-代替序数索引">用 EnumMap 代替序数索引<a hidden class="anchor" aria-hidden="true" href="#用-enummap-代替序数索引">#</a></h2>
<p>麻烦，平时用不到</p>
<h2 id="用接口模拟可扩展的枚举">用接口模拟可扩展的枚举<a hidden class="anchor" aria-hidden="true" href="#用接口模拟可扩展的枚举">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Foo</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bar</span>(String operation);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> SubFoo <span style="color:#66d9ef">implements</span> Foo{
</span></span><span style="display:flex;"><span>    A(<span style="color:#e6db74">&#34;a&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bar</span>(String operation){
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">+</span>operation);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    B(<span style="color:#e6db74">&#34;b&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bar</span>(String operation){
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;b&#34;</span><span style="color:#f92672">+</span>operation);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String s;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SubFoo(String s){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">s</span> <span style="color:#f92672">=</span> s;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="注解优先于命名模式">注解优先于命名模式<a hidden class="anchor" aria-hidden="true" href="#注解优先于命名模式">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Transactional</span>(rollbackFor <span style="color:#f92672">=</span> Exception.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">updateUser</span>(User user){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> userRepository.<span style="color:#a6e22e">updateUser</span>(user);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ExceptionHandler</span>(BindException.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ApiReturnObject <span style="color:#a6e22e">defaultExceptionHandler</span>(BindException bindException) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//处理返回的错误信息</span>
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>ObjectError<span style="color:#f92672">&gt;</span> errors <span style="color:#f92672">=</span> bindException.<span style="color:#a6e22e">getBindingResult</span>().<span style="color:#a6e22e">getAllErrors</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(errors.<span style="color:#a6e22e">size</span>()<span style="color:#f92672">&gt;</span>0){
</span></span><span style="display:flex;"><span>        ObjectError objectError <span style="color:#f92672">=</span> errors.<span style="color:#a6e22e">get</span>(0);
</span></span><span style="display:flex;"><span>        ResultCode resultCode <span style="color:#f92672">=</span> ResultCode.<span style="color:#a6e22e">FAILURE</span>.<span style="color:#a6e22e">setMessage</span>(objectError.<span style="color:#a6e22e">getDefaultMessage</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ApiReturnUtil.<span style="color:#a6e22e">failure</span>(resultCode);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ApiReturnUtil.<span style="color:#a6e22e">failure</span>(ResultCode.<span style="color:#a6e22e">SYSTEM_EXCEPTION</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="坚持使用-override-注解">坚持使用 @Override 注解<a hidden class="anchor" aria-hidden="true" href="#坚持使用-override-注解">#</a></h2>
<p>保证写的代码，在编译时能检查得出来到底有没有重写 父类/接口 的方法。</p>
<h2 id="用标记接口定义类型">用标记接口定义类型<a hidden class="anchor" aria-hidden="true" href="#用标记接口定义类型">#</a></h2>
<p>Spring 中的所有事件，默认继承 EventObject 这个也算是“接口”，一个不成文的规定。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 在使用 ObjectOutputstream 时，如果没有实现 Serializable 接口会报错，仅仅是个标记接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* 在 writeObject0(Object obj, boolean unshared)中，显示的标注了，非 instance of Serializable 实现，将会抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserEntity</span> <span style="color:#66d9ef">implements</span> Serializable{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> id;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 防止被序列化，当然实现了某个接口，还是设置一下，还是会被序列化</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">transient</span> BigDecimal salary;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 标记注解</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Repository</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Compment</span>
</span></span></code></pre></div><h1 id="lambdas-and-streams">Lambdas and Streams<a hidden class="anchor" aria-hidden="true" href="#lambdas-and-streams">#</a></h1>
<h2 id="lambda-优先于匿名类">Lambda 优先于匿名类<a hidden class="anchor" aria-hidden="true" href="#lambda-优先于匿名类">#</a></h2>
<p>接口只有一个待实现方法时，可以转换成<code> Lambda</code> 写法。如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SayHelloInterface</span>{
</span></span><span style="display:flex;"><span>    String <span style="color:#a6e22e">sayHello</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(Stirng<span style="color:#f92672">[]</span> args){
</span></span><span style="display:flex;"><span>    SayHelloInterface hello <span style="color:#f92672">=</span> () <span style="color:#f92672">-&gt;</span> <span style="color:#e6db74">&#34;hello&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>还有 <code>Comparable&lt;T&gt; </code>就是很好用 Lambda 写法的例子，而不是用匿名类去写。</p>
<p>如果 Lambda 没有名称和文档，并且有很多行，那就不要用。</p>
<h2 id="方法引用优先于-lambda">方法引用优先于 Lambda<a hidden class="anchor" aria-hidden="true" href="#方法引用优先于-lambda">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>System.<span style="color:#a6e22e">out</span>::println
</span></span><span style="display:flex;"><span>Integer::parseInt
</span></span></code></pre></div><p>方法引用详情见 《Java 8 实战》</p>
<h2 id="坚持使用标准的函数接口">坚持使用标准的函数接口<a hidden class="anchor" aria-hidden="true" href="#坚持使用标准的函数接口">#</a></h2>
<table>
  <thead>
      <tr>
          <th style="text-align: center">接口</th>
          <th style="text-align: center">函数签名</th>
          <th style="text-align: center">范例</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">UnaryOperator<T></td>
          <td style="text-align: center">T apply(T t)</td>
          <td style="text-align: center">String::toLowerCase</td>
      </tr>
      <tr>
          <td style="text-align: center">BinaryOperator<T></td>
          <td style="text-align: center">T apply(T t1,T t2)</td>
          <td style="text-align: center">BigInteger::add</td>
      </tr>
      <tr>
          <td style="text-align: center">Predicate<T></td>
          <td style="text-align: center">boolean test(T t)</td>
          <td style="text-align: center">Collection::isEmpty</td>
      </tr>
      <tr>
          <td style="text-align: center">Function&lt;T,R&gt;</td>
          <td style="text-align: center">R apply(T t)</td>
          <td style="text-align: center">Arrays::asList</td>
      </tr>
      <tr>
          <td style="text-align: center">Supplier<T></td>
          <td style="text-align: center">T get()</td>
          <td style="text-align: center">Instant::now</td>
      </tr>
      <tr>
          <td style="text-align: center">Consumer<T></td>
          <td style="text-align: center">void accept(T t)</td>
          <td style="text-align: center">System.out::println,Iterable<T>::forEach</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">default</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">forEach</span>(Consumer<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T<span style="color:#f92672">&gt;</span> action) {
</span></span><span style="display:flex;"><span>    Objects.<span style="color:#a6e22e">requireNonNull</span>(action);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (T t : <span style="color:#66d9ef">this</span>) {
</span></span><span style="display:flex;"><span>        action.<span style="color:#a6e22e">accept</span>(t);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 上面的 Supplier 其实是下面的更简化版。</span>
</span></span><span style="display:flex;"><span>Supplier<span style="color:#f92672">&lt;</span>Instant<span style="color:#f92672">&gt;</span> supplier <span style="color:#f92672">=</span> () <span style="color:#f92672">-&gt;</span> (Instant.<span style="color:#a6e22e">now</span>());
</span></span></code></pre></div><p><code>@FunctionalInterface</code></p>
<p>这个注解有三个目的，</p>
<ol>
<li>告诉这个类及其文档的读者，这个接口是针对 Lambda 设计的。</li>
<li>这个接口不会进行编译，除非它只有一个抽象方法</li>
<li>避免后续维护人员不小心给该接口添加抽象方法</li>
</ol>
<p>必须使用这个注解对自己编写的函数接口进行标注。</p>
<h2 id="谨慎使用-stream">谨慎使用 Stream<a hidden class="anchor" aria-hidden="true" href="#谨慎使用-stream">#</a></h2>
<p>不建议使用 Stream 来进行 SQL 查询之类的操作。</p>
<p>过度地使用函数式编程，会导致代码可读性变差，强调不要滥用</p>
<h1 id="methods">Methods<a hidden class="anchor" aria-hidden="true" href="#methods">#</a></h1>
<h2 id="检查参数的有效性">检查参数的有效性<a hidden class="anchor" aria-hidden="true" href="#检查参数的有效性">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 方法尽量是个动词，方法是行为/动作</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">validate</span>(String str,Collection collection,Object obj){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(StringUtils.<span style="color:#a6e22e">isEmpty</span>(str)){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这里是 apache common 包下的工具类，hutool 也有类似的类</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(CollectionUtils.<span style="color:#a6e22e">isEmpty</span>(collection)){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Objects.<span style="color:#a6e22e">requireNonNull</span>(obj,<span style="color:#e6db74">&#34;obj is null&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 其他操作....</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">a</span>(String str){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在违背导出的方法，使用断言，确保什么时候能够调用这个方法</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> str.<span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> 1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="必要时进行保护性拷贝">必要时进行保护性拷贝<a hidden class="anchor" aria-hidden="true" href="#必要时进行保护性拷贝">#</a></h2>
<p>对于参数类型可以被不可信任方子类化的参数，请不要使用 clone 方法进行保护性拷贝。</p>
<h2 id="谨慎设计方法签名">谨慎设计方法签名<a hidden class="anchor" aria-hidden="true" href="#谨慎设计方法签名">#</a></h2>
<p>代码整洁之道</p>
<p>对于参数类型，优先使用接口而不是具体实现类。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">BeanDefinitionRegistryPostProcessor</span> <span style="color:#66d9ef">extends</span> BeanFactoryPostProcessor {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Modify the application context&#39;s internal bean definition registry after its
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * standard initialization. All regular bean definitions will have been loaded,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * but no beans will have been instantiated yet. This allows for adding further
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * bean definitions before the next post-processing phase kicks in.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param registry the bean definition registry used by the application context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @throws org.springframework.beans.BeansException in case of errors
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postProcessBeanDefinitionRegistry</span>(BeanDefinitionRegistry registry) <span style="color:#66d9ef">throws</span> BeansException;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//BeanDefinitionRegistry 常用实现为 DefaultListableBeanFactory，也有其他 ApplicationContext 实现</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>boolean 参数，优先使用两个元素的枚举类型。</p>
<h2 id="慎用重载">慎用重载<a hidden class="anchor" aria-hidden="true" href="#慎用重载">#</a></h2>
<p>不要在重载方法中使用范型，或者继承关系类型。如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>getAll(List<span style="color:#f92672">&lt;?&gt;</span> list);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>getAll(Collection<span style="color:#f92672">&lt;?&gt;</span> collection);
</span></span></code></pre></div><p>需要调用哪个重载方法是在编译时作出决定的。</p>
<p>对于重载方法的选择是静态的，而对于被覆盖的方法的选择则是动态的。</p>
<h2 id="慎用可变参数">慎用可变参数<a hidden class="anchor" aria-hidden="true" href="#慎用可变参数">#</a></h2>
<p>可变参数其实是个语法糖</p>
<p>每次调用可变参数方法都会导致一次数组分配和初始化。有性能问题。可以适当的利用重载方法，替代可变参数方法。当然方法参数超过3个，就一起用可变参数，具体方法参数内容可以参考《代码整洁之道》。</p>
<p>最理想的参数数量是零，其次是一，再次是二，尽量避免三。有足够特殊的理由才能用三个以上参数（阿里巴巴Java开发手册：相同参数类型，相同业务含义，才可以使用 Java 的可变参数，可变参数放在最后，尽量不用可变参数，避免使用 Object）。</p>
<p><a href="https://yq.aliyun.com/articles/684075?spm=a2c4e.11155435.0.0.1e463312jtOsPe">很久以前记的《代码整洁之道》的笔记</a></p>
<h2 id="返回零长度的数组或者集合而不是-null">返回零长度的数组或者集合，而不是 null<a hidden class="anchor" aria-hidden="true" href="#返回零长度的数组或者集合而不是-null">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">getDigestKeyGen</span>(String content){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// doSomething</span>
</span></span><span style="display:flex;"><span>        bytes <span style="color:#f92672">=</span> xxxx;
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">catch</span>(Exception e){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="谨慎返回-optional">谨慎返回 optional<a hidden class="anchor" aria-hidden="true" href="#谨慎返回-optional">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// DefaultListableBeanFactory</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Create an {@link Optional} wrapper for the specified dependency.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Optional<span style="color:#f92672">&lt;?&gt;</span> createOptionalDependency(
</span></span><span style="display:flex;"><span>    DependencyDescriptor descriptor, <span style="color:#a6e22e">@Nullable</span> String beanName, <span style="color:#66d9ef">final</span> Object... args) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DependencyDescriptor descriptorToUse <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NestedDependencyDescriptor(descriptor) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isRequired</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">resolveCandidate</span>(String beanName, Class<span style="color:#f92672">&lt;?&gt;</span> requiredType, BeanFactory beanFactory) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> (<span style="color:#f92672">!</span>ObjectUtils.<span style="color:#a6e22e">isEmpty</span>(args) <span style="color:#f92672">?</span> beanFactory.<span style="color:#a6e22e">getBean</span>(beanName, args) :
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">resolveCandidate</span>(beanName, requiredType, beanFactory));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    Object result <span style="color:#f92672">=</span> doResolveDependency(descriptorToUse, beanName, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (result <span style="color:#66d9ef">instanceof</span> Optional <span style="color:#f92672">?</span> (Optional<span style="color:#f92672">&lt;?&gt;</span>) result : Optional.<span style="color:#a6e22e">ofNullable</span>(result));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Optional</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这个 value 就是该对象的引用</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> T value;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这里是空的兜底的策略时，返回的 Optional null 对象</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Optional<span style="color:#f92672">&lt;?&gt;</span> EMPTY <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Optional<span style="color:#f92672">&lt;&gt;</span>();
</span></span></code></pre></div><p>常用的方法 <code>Optional.ofNullable(result)</code>，返回一个<code> Optional(null)</code>或者 <code>Optional</code> 的包装对象的。</p>
<p><strong>Optional&lt;T&gt; 类代表的是一个不可变的容器，它可以存放单个非 null 的 T 引用，或者什么内容都没有</strong>。</p>
<ol>
<li>
<p>永远不要通过返回 Optional 的方法返回 null，因为它彻底违背了 optional（可选的） 的本意。</p>
</li>
<li>
<p>容器类型含<code>集合</code>、<code>映射</code>、<code>Stream</code>、<code>数组</code>和<code> optional</code>，都不应该被包装在 optional 中。</p>
</li>
<li>
<p>永远不要返回基本包装类型的 optional 。已经提供了 <code>OptionalInt</code>，<code>OptionalDouble</code>，<code>OptionalLong </code>等。</p>
</li>
<li>
<p>永远都不适合用 optional 作为键、值，或者集合或做数组中的元素。</p>
</li>
<li>
<p>尽量不要将 Optional 用作返回值以外的任何其他用途。</p>
</li>
</ol>
<p>用了 Optional，你就必须在调用方，做相应的判断，因为如果使用 <code>Optional.ofNullable(obj)</code>它有最差返回 <code>private static final Optional&lt;?&gt; EMPTY = new Optional&lt;&gt;();</code></p>
<h2 id="为所有到处的-api-元素编写文档注释">为所有到处的 API 元素编写文档注释<a hidden class="anchor" aria-hidden="true" href="#为所有到处的-api-元素编写文档注释">#</a></h2>
<p>《代码整洁之道》—— 最好的注释是方法本身（见名知意、简短 <code>不超过 50 行</code>、方法参数最好不要超过 3 个、少用可变参数）。</p>
<p>当然这是一种比较极端的说法，好的 API 应该至少写出 what why how，这个方法是什么，为什么这么实现，以及如何使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// interface BeanFactory	</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Return an instance, which may be shared or independent, of the specified bean.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * &lt;p&gt;Behaves the same as {@link #getBean(String)}, but provides a measure of type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * safety by throwing a BeanNotOfRequiredTypeException if the bean is not of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * required type. This means that ClassCastException can&#39;t be thrown on casting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * the result correctly, as can happen with {@link #getBean(String)}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * &lt;p&gt;Translates aliases back to the corresponding canonical bean name.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Will ask the parent factory if the bean cannot be found in this factory instance.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param name the name of the bean to retrieve
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param requiredType type the bean must match; can be an interface or superclass
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return an instance of the bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @throws NoSuchBeanDefinitionException if there is no such bean definition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @throws BeanNotOfRequiredTypeException if the bean is not of the required type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @throws BeansException if the bean could not be created
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> T <span style="color:#a6e22e">getBean</span>(String name, Class<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> requiredType) <span style="color:#66d9ef">throws</span> BeansException;
</span></span></code></pre></div><p>使用<code> {@literal}</code>忽略尖括号等需要转义的内容。如 <code> {@literal r &lt; 1}</code></p>
<h1 id="general-programing">General Programing<a hidden class="anchor" aria-hidden="true" href="#general-programing">#</a></h1>
<h2 id="将局部变量的作用域最小化">将局部变量的作用域最小化<a hidden class="anchor" aria-hidden="true" href="#将局部变量的作用域最小化">#</a></h2>
<p><strong>只在需要用到变量的前一步，去声明变量。</strong></p>
<p>下面是<code>AutowiredAnnotationBeanPostProcessor</code>覆盖<code>SmartInstantiationAwareBeanPostProcessor</code>的方法。</p>
<p>具体执行步骤 <code>AbstractAutowireCapaleBeanFactory#doCreateBean</code> -&gt; <code>AbstractAutowireCapaleBeanFactory#createBeanInstance</code> -&gt; <code>AbstractAutowireCapaleBeanFactory#determineConstructorsFromBeanPostProcessors</code> -&gt; <code>SmartInstantiationAwareBeanPostProcessor#determineCandidateConstructors</code>  -&gt;<code>AutowiredAnnotationBeanPostProcessor#determineCandidateConstructors</code></p>
<p>在属性填充之前，创建 beanWrapper。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Nullable</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Constructor<span style="color:#f92672">&lt;?&gt;[]</span> determineCandidateConstructors(Class<span style="color:#f92672">&lt;?&gt;</span> beanClass, <span style="color:#66d9ef">final</span> String beanName)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> BeanCreationException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Let&#39;s check for lookup methods here..</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lookupMethodsChecked</span>.<span style="color:#a6e22e">contains</span>(beanName)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            ReflectionUtils.<span style="color:#a6e22e">doWithMethods</span>(beanClass, method <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>                Lookup lookup <span style="color:#f92672">=</span> method.<span style="color:#a6e22e">getAnnotation</span>(Lookup.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (lookup <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    Assert.<span style="color:#a6e22e">state</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanFactory</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#34;No BeanFactory available&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 检查 Lookup 方法，去覆盖原来的方法</span>
</span></span><span style="display:flex;"><span>                    LookupOverride override <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LookupOverride(method, lookup.<span style="color:#a6e22e">value</span>());
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                        RootBeanDefinition mbd <span style="color:#f92672">=</span> (RootBeanDefinition) <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">beanFactory</span>.<span style="color:#a6e22e">getMergedBeanDefinition</span>(beanName);
</span></span><span style="display:flex;"><span>                        mbd.<span style="color:#a6e22e">getMethodOverrides</span>().<span style="color:#a6e22e">addOverride</span>(override);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">catch</span> (NoSuchBeanDefinitionException ex) {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanCreationException(beanName,
</span></span><span style="display:flex;"><span>                                                        <span style="color:#e6db74">&#34;Cannot apply @Lookup to beans without corresponding bean definition&#34;</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (IllegalStateException ex) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanCreationException(beanName, <span style="color:#e6db74">&#34;Lookup method resolution failed&#34;</span>, ex);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lookupMethodsChecked</span>.<span style="color:#a6e22e">add</span>(beanName);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略后面代码</span>
</span></span><span style="display:flex;"><span>}    
</span></span></code></pre></div><p><code>for</code> 循环优先于 <code>while</code> 循环</p>
<h2 id="优先使用-foreach-而不是-for">优先使用 foreach 而不是 for<a hidden class="anchor" aria-hidden="true" href="#优先使用-foreach-而不是-for">#</a></h2>
<p>简洁、灵活、预防出错（当然在里面删除元素又进行遍历，是不行的）</p>
<p>不要在 foreach（增强 for 循环） 里面进行删除集合内部元素的操作。如果必要，请使用迭代器。</p>
<p><strong>什么时候不该用 foreach</strong></p>
<ol>
<li>
<p>解构过滤：就是上面的情况，使用 Collection#removeIf。</p>
</li>
<li>
<p>转换：就是要明确知道要替换的元素在哪几位的时候，予以替换的时候。</p>
</li>
<li>
<p>平行迭代：多层迭代，例如排序算法</p>
</li>
</ol>
<p><strong>正确的在遍历时删除元素</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">filter</span>(List<span style="color:#f92672">&lt;</span>User<span style="color:#f92672">&gt;</span> users){
</span></span><span style="display:flex;"><span>    Iterator<span style="color:#f92672">&lt;</span>User<span style="color:#f92672">&gt;</span> it <span style="color:#f92672">=</span> users.<span style="color:#a6e22e">iterator</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(it.<span style="color:#a6e22e">hasNext</span>()){
</span></span><span style="display:flex;"><span>        User user <span style="color:#f92672">=</span> it.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(user <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#e6db74">&#34;zhangSan&#34;</span>.<span style="color:#a6e22e">equals</span>(user.<span style="color:#a6e22e">name</span>)){
</span></span><span style="display:flex;"><span>            it.<span style="color:#a6e22e">remove</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="了解和使用类库">了解和使用类库<a hidden class="anchor" aria-hidden="true" href="#了解和使用类库">#</a></h2>
<p>从 Java7 开始该使用 ThreadLocalRandom 而不是 Random</p>
<p>熟悉 java.lang、java.util、java.io及其子包中的内容。子包包括但不限于 java.util.concurrent，java.util.regex。</p>
<h2 id="如果需要精确的答案避免使用-float-和-double">如果需要精确的答案，避免使用 float 和 double<a hidden class="anchor" aria-hidden="true" href="#如果需要精确的答案避免使用-float-和-double">#</a></h2>
<p>float、double 适合科学计算。</p>
<p>使用 BigDecimal、Joda Money 进行金额计算。</p>
<p>JavaScript</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// js
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0.1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.2</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0.3</span> <span style="color:#75715e">// true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//0.1 +0.2===0.30000000000000004
</span></span></span></code></pre></div><p>Java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">double</span> a <span style="color:#f92672">=</span> 0.<span style="color:#a6e22e">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">double</span> b <span style="color:#f92672">=</span> 0.<span style="color:#a6e22e">3</span>;
</span></span><span style="display:flex;"><span>System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(b<span style="color:#f92672">-</span>a <span style="color:#f92672">==</span> 0.<span style="color:#a6e22e">2</span>);<span style="color:#75715e">// false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">double</span> d <span style="color:#f92672">=</span> b<span style="color:#f92672">-</span>a;
</span></span><span style="display:flex;"><span>System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(d);<span style="color:#75715e">// 0.19999999999999998</span>
</span></span></code></pre></div><h2 id="基本类型优先于装箱基本类型">基本类型优先于装箱基本类型<a hidden class="anchor" aria-hidden="true" href="#基本类型优先于装箱基本类型">#</a></h2>
<p>基本类型比包装类型更省内存，性能更高。当然，业务对性能要求不是非常高的，可以用装箱的类型。</p>
<p>自动拆装箱会带来一些隐藏的问题，在《阿里巴巴 Java 开发手册》中介绍，统一使用装箱类型。</p>
<p>如果基本类型和装箱基本类型混合使用，装箱基本类型则会自动拆箱。</p>
<p>自动拆装箱本质上是为了简化开发，添加此类语法糖。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 编译时优化，自动装箱</span>
</span></span><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>(2);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 实际上是 list.add(Integer.valueOf(1));</span>
</span></span><span style="display:flex;"><span>list.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 编译时优化，自动拆箱</span>
</span></span><span style="display:flex;"><span>Integer a <span style="color:#f92672">=</span> 129;
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> 1 <span style="color:#f92672">*</span> a;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 自动装箱时，会在 IntegerCache 中查找是否有缓存中的元素，有即返回，这个最大值可以设置，最小值为 -128，low=-128，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  String integerCacheHighPropValue =</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                sun.misc.VM.getSavedProperty(&#34;java.lang.Integer.IntegerCache.high&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Integer <span style="color:#a6e22e">valueOf</span>(<span style="color:#66d9ef">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> IntegerCache.<span style="color:#a6e22e">low</span> <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;=</span> IntegerCache.<span style="color:#a6e22e">high</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> IntegerCache.<span style="color:#a6e22e">cache</span><span style="color:#f92672">[</span>i <span style="color:#f92672">+</span> (<span style="color:#f92672">-</span>IntegerCache.<span style="color:#a6e22e">low</span>)<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Integer(i);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="如果其他类型更合适尽量避免使用字符串">如果其他类型更合适，尽量避免使用字符串<a hidden class="anchor" aria-hidden="true" href="#如果其他类型更合适尽量避免使用字符串">#</a></h2>
<p>不适合代替枚举类型的值、聚合类型、能力表（capabilities）。</p>
<p>ThreadLocal 如果用 String 作为 Key，那将是全局共享的，不妥。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 聚合类型</span>
</span></span><span style="display:flex;"><span>String compoundKey <span style="color:#f92672">=</span> className <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#f92672">+</span> i.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Spring 中也是这么做的。 </span>
</span></span><span style="display:flex;"><span>String methodName <span style="color:#f92672">=</span> className <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;#&#34;</span><span style="color:#f92672">+</span> methodName;
</span></span></code></pre></div><p><code>1kb = 1024 byte = 1024 * 8 bit</code></p>
<table>
  <thead>
      <tr>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>名称</td>
          <td>长度</td>
          <td>备注</td>
      </tr>
      <tr>
          <td>byte</td>
          <td>字节型</td>
          <td>8bit</td>
          <td>表示数据范围：-128~127</td>
      </tr>
      <tr>
          <td>short</td>
          <td>短整型</td>
          <td>16bit</td>
          <td></td>
      </tr>
      <tr>
          <td>char</td>
          <td>字符型</td>
          <td>16bit</td>
          <td></td>
      </tr>
      <tr>
          <td>int</td>
          <td>整型</td>
          <td>32bit</td>
          <td></td>
      </tr>
      <tr>
          <td>long</td>
          <td>长整型</td>
          <td>8 byte</td>
          <td></td>
      </tr>
      <tr>
          <td>float</td>
          <td>单精度浮点型</td>
          <td>4 byte</td>
          <td>精度：7-8位</td>
      </tr>
      <tr>
          <td>double</td>
          <td>双精度浮点型</td>
          <td>8 byte</td>
          <td></td>
      </tr>
      <tr>
          <td>boolean</td>
          <td>布尔型</td>
          <td>true/false</td>
          <td>实际用 byte 存储，0 为 false，1 为 true</td>
      </tr>
  </tbody>
</table>
<p>选择合适的类型，能使得占用内存更小。</p>
<p>当然，为防止伪共享，提高 CPU 执行效率，如果使用 volatile 关键字禁止 CPU 缓存，如果需要提升代码性能，需要额外填充其他对象。</p>
<p>如果一个对象包含线程局部变量且尺寸小于 64byte，就有可能发生伪共享。在Java7之前，一般通过对象填充的方式来避免伪共享问题：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// java7 以前</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PaddedVolatileLong</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> v;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> p1, p2, p3, p4, p5, p6;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// java 8 加上注解，加上启动参数，自动填充。</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@sun.misc.Contended</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ForkJoinPool</span> <span style="color:#66d9ef">extends</span> AbstractExecutorService {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>需要给JVM加上启动项参数：</p>
<p><strong>-XX:-RestrictContended</strong></p>
<p>Hotspot虚拟机文档 “oops/oop.hp”有对Markword字段的定义</p>
<pre tabindex="0"><code>  64 bits:
  --------
  unused:25 hash:31 --&gt;| unused:1   age:4    biased_lock:1 lock:2 (normal object)
  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)
  PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)
  size:64 -----------------------------------------------------&gt;| (CMS free block)
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Fruit</span> <span style="color:#66d9ef">extends</span> Object {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> size;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Object object <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object();
</span></span><span style="display:flex;"><span>Fruit fruit <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Fruit();
</span></span></code></pre></div><ul>
<li>Object 对象，Markword  8 个字节，kclass 4 个字节， 加起来 12 个字节，加上 4 个字节的对齐填充，占用的空间是 16 个字节。</li>
<li>Fruit 对象， Markword 8 个字节，kclass 4 个字节，还有个 size 成员变量，int类型占 4 个字节，加起来是 16 个字节，不需要对齐填充</li>
</ul>
<p>缓存行非64字节宽的处理器。如P6系列和奔腾处理器，它们的L1和L2高速缓存行是32个字节宽。</p>
<p>共享变量不会被频繁地写。因为使用追加字节的方式需要处理器读取更多的字节到高速缓冲区，这本身就会带来一定的性能消耗，如果共享变量不被频繁写的话，锁的几率也非常小，就没必要通过追加字节的方式来避免相互锁定。</p>
<h2 id="了解字符串连接的性能">了解字符串连接的性能<a hidden class="anchor" aria-hidden="true" href="#了解字符串连接的性能">#</a></h2>
<p>避免在循环使用 <code>+</code> 拼接字符串</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0;i <span style="color:#f92672">&lt;</span> 1000;i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    String str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#f92672">+</span> strs<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 实际代码为</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * StringBuilder sb = new StringBuilder();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  *	sb.append(str);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * sb.append(strs[i]);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * sb.toString();
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="通过接口引用对象">通过接口引用对象<a hidden class="anchor" aria-hidden="true" href="#通过接口引用对象">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>User<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span></code></pre></div><p>更加灵活。</p>
<h3 id="样例">样例<a hidden class="anchor" aria-hidden="true" href="#样例">#</a></h3>
<p>实际碰到的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ArrayList<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getList</span>(){
</span></span><span style="display:flex;"><span>    ArrayList<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> aService.<span style="color:#a6e22e">getList</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> list;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>当我需要按照构造器传入的 size 来截取 List，因为我客户端需要根据 pageSize 来获取指定 size 或小于该大小的数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ArrayList<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getList</span>(){
</span></span><span style="display:flex;"><span>    ArrayList<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> aService.<span style="color:#a6e22e">getList</span>();
</span></span><span style="display:flex;"><span>    SubList subList <span style="color:#f92672">=</span> list.<span style="color:#a6e22e">subList</span>(0,10);
</span></span><span style="display:flex;"><span>   	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ArrayList(subList);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我只是需要个 JSON 数组，我并不需要 ArrayList 的特殊的方法，这样就是<strong>严重耦合</strong>的代码。</p>
<p>这个改成下面的，是不是更好点？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getList</span>(){
</span></span><span style="display:flex;"><span>    List<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> aService.<span style="color:#a6e22e">getList</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> list.<span style="color:#a6e22e">subList</span>(0,10);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Spring 中大量使用接口来引用，而非具体实现类。代码尽量使用依赖注入接口类型，实现实际类与调用类解耦。</p>
<p>如果没有合适的接口，就用<strong>类层次结构中提供了必要功能的最小的具体类</strong>来引用对象。</p>
<p>即如果要使用<code>ArrayList.trimToSize()</code>就声明为 <code>ArrayList</code> 引用，这是一种编程习惯，只用你用到的，只提供你想给外部调用的，不是全部，是部分（部分可以是全部）。</p>
<p>Spring 中是采用的流水线的思维方式，将各个阶段，抽象了出来，每个阶段都有其对应的接口抽象。</p>
<p>每个阶段的抽象。</p>
<ol>
<li>BeanFactory</li>
<li>Resource</li>
<li>BeanDefinition</li>
<li>BeanWrapper</li>
</ol>
<p>每个阶段中的前置后置处理抽象</p>
<ol>
<li>BeanFactoryPostProcessor（BeanFactory 启动的时候，可以在 <code>AbstractApplicationContext#invokeBeanFactoryPostProcessors</code> 中找到答案，打断点，自己慢慢看，就知道 @Component 是在这里的哪一步解析的了，启动一个随便什么的 Spring Boot 项目，即可查看具体内容）</li>
<li>BeanDefinitionRegistryPostProcessor（BeanDefnition 注册的时候）</li>
<li>MergedBeanDefinitionPostProcessor（GenericBeanDefinition 和其他 BeanDefinition 有个合并的过程，合并成 RooBeanDefinition，如果你看过小马哥的讲解的，这个其实是 XML 配置里面会出现的情况，一个 &lt;bean/&gt; 就是一个 RootBeanDefinition，当然，它会先包装成 GenericBeanDefinition 再进行合并）</li>
<li>SmartInstantiationAwareBeanPostProcessor（一般带 Smart 的，都要先一步执行，例如 SmartInitializingSingleton，会在单例对象<strong>预实例化</strong>阶执行，SmartInstantiationAwareBeanPostProcessor 的实现的抽象类 <code>AbstractAdvisorAutoProxyCreator</code> 和 AOP 相关，就在这一步，对要拦截的 Bean 进行拦截，然后代理，这里会有 Pattern 正则来匹配的过程，@Transaction 也是在这一步做的）</li>
<li>InstantiationAwareBeanPostProcessor</li>
<li>DestructionAwareBeanPostProcessor</li>
<li>BeanPostProcessor（上面所有 BeanPostProcessor 的父类，就是最卑微的，最后执行）</li>
</ol>
<h2 id="接口优先于反射机制">接口优先于反射机制<a hidden class="anchor" aria-hidden="true" href="#接口优先于反射机制">#</a></h2>
<p><strong>详情见</strong></p>
<p>Spring <code>BeanProcessor</code></p>
<p>InitializingBean 和 DisposableBean，它们也可以用 @PostConstruct 和 @PreDestroy 代替，当然，两者一起也是可以的，具体执行顺序。</p>
<ul>
<li>
<p>@PostConstruct</p>
</li>
<li>
<p>InitializingBean</p>
</li>
<li>
<p>自定义初始化方法</p>
</li>
<li>
<p>@PreDestroy 标注方法</p>
</li>
<li>
<p>实现 DisposableBean 接口的 destroy() 方法</p>
</li>
<li>
<p>自定义销毁方法 (destroy-mehod)</p>
</li>
</ul>
<p>Spring MVC <code>Interceptor</code></p>
<p>给定了模版类，调用模版类的模版方法。</p>
<p>如果使用反射机制</p>
<ul>
<li>损失了编译时类型检查的优势</li>
<li>执行反射访问所需要的代码非常笨拙和冗长</li>
<li>性能损失</li>
</ul>
<h2 id="谨慎使用本地方法">谨慎使用本地方法<a hidden class="anchor" aria-hidden="true" href="#谨慎使用本地方法">#</a></h2>
<p>native method 是与平台相关的，破坏了 Java 的移植性，如非必须情况，要避免使用本地方法。</p>
<p>可能的必要情况</p>
<ul>
<li>需要调用 dll 文件</li>
<li>需要真正高性能的高精度算术运算。</li>
</ul>
<h2 id="谨慎地进行优化">谨慎地进行优化<a hidden class="anchor" aria-hidden="true" href="#谨慎地进行优化">#</a></h2>
<p>不等同于不要持续重构代码</p>
<h2 id="遵守普遍接受的命名惯例">遵守普遍接受的命名惯例<a hidden class="anchor" aria-hidden="true" href="#遵守普遍接受的命名惯例">#</a></h2>
<ol>
<li>包名com.xxxx，域名反写</li>
<li>类名 抽象类，BaseXXXXX，AbstractXXXXXX</li>
<li>变量名 局部变量名，String xxxStr，</li>
<li>方法名 方法名应该是个动词，如 createBean，getBean，表示的是类的行为。</li>
<li>get 是获取单个对象，list 是获取多个对象。</li>
</ol>
<h3 id="题外话">题外话<a hidden class="anchor" aria-hidden="true" href="#题外话">#</a></h3>
<p><strong>怪罪于</strong> StringBuilder sb = new StringBuilder(100); 命名为 sb 的人，是真的 SB。本来就是局部变量用于拼接字符串的，没有很大的实际意义。</p>
<p>有些现代工具（MyBatis）依赖 Beans 命名惯例，setter getter，从数据库中取出值后，赋值需要调用 setter 类型方法。</p>
<h1 id="exception">Exception<a hidden class="anchor" aria-hidden="true" href="#exception">#</a></h1>
<h2 id="只针对异常的情况才使用异常">只针对异常的情况才使用异常<a hidden class="anchor" aria-hidden="true" href="#只针对异常的情况才使用异常">#</a></h2>
<p>不要将异常作为普通的控制流。</p>
<h2 id="对可恢复的情况使用受检异常对编程错误使用运行时异常">对可恢复的情况使用受检异常，对编程错误使用运行时异常<a hidden class="anchor" aria-hidden="true" href="#对可恢复的情况使用受检异常对编程错误使用运行时异常">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// 可恢复情况</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>    Class.<span style="color:#a6e22e">forName</span>(<span style="color:#e6db74">&#34;com.xxx.Driver&#34;</span>);
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">catch</span>(ClassNotFoundException e){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 编程错误使用 RuntimeException</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> foo <span style="color:#f92672">=</span> 1<span style="color:#f92672">/</span>0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Error 最好由 JVM 抛出，不适合自定义 Error</span>
</span></span></code></pre></div><h2 id="避免不必要地使用受检异常">避免不必要地使用受检异常<a hidden class="anchor" aria-hidden="true" href="#避免不必要地使用受检异常">#</a></h2>
<p>可以适当将 try catch 块重构为 if else 块。</p>
<h2 id="优先使用标准的异常">优先使用标准的异常<a hidden class="anchor" aria-hidden="true" href="#优先使用标准的异常">#</a></h2>
<p>类越精简，加载类的速度越快，优先使用专家级的定义的异常。加粗表示更为高频使用的，如</p>
<ul>
<li>
<p>IndexOfBoundsException</p>
</li>
<li>
<p>NullPointException</p>
</li>
<li>
<p><strong>IllegalArgumentException</strong></p>
</li>
<li>
<p><em>IllegalStateException</em>*</p>
</li>
<li>
<p>IllegalAccessException</p>
</li>
<li>
<p>ConcurrentModificationException</p>
</li>
<li>
<p>UnsupportedOperationException</p>
</li>
</ul>
<h2 id="抛出与抽象对应的异常">抛出与抽象对应的异常<a hidden class="anchor" aria-hidden="true" href="#抛出与抽象对应的异常">#</a></h2>
<p>更高层的实现应该捕获底层的异常，同时抛出可以按照高层抽象进行解释的异常。</p>
<p>如果在 MyBatis 中，写 resultType 写成不存在的类，会先抛出 ClassNotFoundException，然后层层抛出，到 Spring 创建 Bean 的步骤中。最终由 Servlet 容器捕获，然后停止启动项目。<strong>可以自己手动试试</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// AbstractAutowireCapableBeanFactory</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> BeanWrapper <span style="color:#a6e22e">autowireConstructor</span>(String beanName, RootBeanDefinition mbd, <span style="color:#a6e22e">@Nullable</span> Constructor<span style="color:#f92672">&lt;?&gt;[]</span> ctors, <span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">[]</span> explicitArgs) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">new</span> ConstructorResolver(<span style="color:#66d9ef">this</span>)).<span style="color:#a6e22e">autowireConstructor</span>(beanName, mbd, ctors, explicitArgs);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// org.springframework.beans.factory.support.ConstructorResolver</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ConstructorResolver.ArgumentsHolder createArgumentArray 方法里面</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    Object autowiredArgument <span style="color:#f92672">=</span> resolveAutowiredArgument(
</span></span><span style="display:flex;"><span>        methodParam, beanName, autowiredBeanNames, converter, fallback);
</span></span><span style="display:flex;"><span>    args.<span style="color:#a6e22e">rawArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> autowiredArgument;
</span></span><span style="display:flex;"><span>    args.<span style="color:#a6e22e">arguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> autowiredArgument;
</span></span><span style="display:flex;"><span>    args.<span style="color:#a6e22e">preparedArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AutowiredArgumentMarker();
</span></span><span style="display:flex;"><span>    args.<span style="color:#a6e22e">resolveNecessary</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">catch</span> (BeansException ex) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsatisfiedDependencyException(
</span></span><span style="display:flex;"><span>        mbd.<span style="color:#a6e22e">getResourceDescription</span>(), beanName, <span style="color:#66d9ef">new</span> InjectionPoint(methodParam), ex);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>异常链（exception chaining），如果低层的异常对于调试导致高层异常的问题非常有帮助，使用异常链就很合适。Spring 就是这样。</p>
<p>实际 WEB 开发也是不要将异常捕获，尽量将异常向上抛出，最终由 **容器/框架 **进行 <strong>捕获/抛出</strong>。编写自定义含 @ExceptionHandler的类，进行捕获异常。</p>
<p>如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestControllerAdvice</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GlobalExceptionHandler</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * 表单验证时异常返回信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * @param bindException 绑定异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * @return 带异常的 ResponseEntiy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * @author 杨逸林
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * @date 2019-07-29 22:27
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">@ExceptionHandler</span>(BindException.<span style="color:#a6e22e">class</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">public</span> ResponseEntity<span style="color:#f92672">&lt;?&gt;</span> defaultExceptionHandler(BindException bindException) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//处理返回的错误信息</span>
</span></span><span style="display:flex;"><span>		List<span style="color:#f92672">&lt;</span>ObjectError<span style="color:#f92672">&gt;</span> errors <span style="color:#f92672">=</span> bindException.<span style="color:#a6e22e">getBindingResult</span>().<span style="color:#a6e22e">getAllErrors</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>CollectionUtils.<span style="color:#a6e22e">isEmpty</span>(errors)) {
</span></span><span style="display:flex;"><span>			ObjectError objectError <span style="color:#f92672">=</span> errors.<span style="color:#a6e22e">get</span>(0);
</span></span><span style="display:flex;"><span>			ResultCode resultCode <span style="color:#f92672">=</span> ResultCode.<span style="color:#a6e22e">FAILURE</span>.<span style="color:#a6e22e">setMessage</span>(objectError.<span style="color:#a6e22e">getDefaultMessage</span>());
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> ResponseEntity.<span style="color:#a6e22e">status</span>(HttpStatus.<span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span>).<span style="color:#a6e22e">body</span>(resultCode);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ResponseEntity.<span style="color:#a6e22e">status</span>(HttpStatus.<span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span>).<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>注意⚠️</p>
<p>这里必须使用 ResponseEntity，不要自定义的什么乱七八糟的返回，没有必要再套一层，HTTP 早就想到了，<strong>不要</strong>像下面这样返回！！多此一举，如果这么做，多半不了解 HTTP 的一些细节内容，前人早就帮你想好了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;code&#34;</span> : <span style="color:#e6db74">&#34;404&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;message&#34;</span> : <span style="color:#e6db74">&#34;can&#39;t find any matches response&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;data&#34;</span> : <span style="color:#e6db74">&#34;404&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样做，只会徒增前端的负担。</p>
<h2 id="每个方法抛出的所有异常都要建立文档">每个方法抛出的所有异常都要建立文档<a hidden class="anchor" aria-hidden="true" href="#每个方法抛出的所有异常都要建立文档">#</a></h2>
<p>永远不要声明一个公有方法直接 “throws Exception”。无法让调用者判断该如何解决并捕获该异常。</p>
<p>有个例外，就是 main 方法，它可以被安全地声明抛出 Exception，因为它只通过虚拟机调用。</p>
<p>还有就是 Spring Boot 的 CommandRunner，ApplicationRunner 以及 Spring 的 InitializingBean。注意这里的 @throws 需要你写清楚，像下面那样。如何写，在我的另一个我在公司分享的【代码规范】文章里面有讲解、翻译。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">InitializingBean</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Invoked by the containing {@code BeanFactory} after it has set all bean properties
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * and satisfied {@link BeanFactoryAware}, {@code ApplicationContextAware} etc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * &lt;p&gt;This method allows the bean instance to perform validation of its overall
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * configuration and final initialization when all bean properties have been set.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @throws Exception in the event of misconfiguration (such as failure to set an
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * essential property) or if initialization fails for any other reason
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span>() <span style="color:#66d9ef">throws</span> Exception;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="在细节消息中包含失败-捕获信息">在细节消息中包含失败-捕获信息<a hidden class="anchor" aria-hidden="true" href="#在细节消息中包含失败-捕获信息">#</a></h2>
<p>为了捕获失败，异常的细节信息应该包含“对该异常由贡献”的所有参数和域的值。</p>
<p>以下是 Spring 启动创建 Bean 时失败，抛出异常的堆栈异常信息。PS：就是上面说的 MyBatis 改了 resultType 的异常。<strong>这里就是按层级抛出异常的案例</strong>。注意：Spring 是以流水线（Pipeline）的形式来处理的 Bean，看过卓别林的《摩登时代》里面就有他在拧螺丝，是流水线上的一环，也是一个阶段的处理者。流水线是福特提出的，并且作用于福特汽车的生产，极大得提高了生产力。在软件行业同样适用，如果你懂了 Spring 是流水线的处理思想（没什么书上提到流水线和 Spring 的关系），你就懂了大半的 Spring，其他的注解解析，派生等等内容都不难。思想很重要，每个人都需要拥有多个学科的知识，例如达芬奇是<strong>画家</strong>、科学家、发明家。这个观念在查理·芒格的《穷查理宝典》中反复被提及，值得一看的书籍。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">beans</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">UnsatisfiedDependencyException</span>: Error creating bean with name <span style="color:#960050;background-color:#1e0010">&#39;</span>callEvaluationController<span style="color:#960050;background-color:#1e0010">&#39;</span> defined in file <span style="color:#f92672">[/</span>IdeaProjects<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>classes<span style="color:#f92672">/</span>cn<span style="color:#f92672">/</span>luckyray<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>api<span style="color:#f92672">/</span>CallEvaluationController.<span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>: Unsatisfied dependency expressed through constructor parameter 0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nested exception is org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">beans</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">UnsatisfiedDependencyException</span>: Error creating bean with name <span style="color:#960050;background-color:#1e0010">&#39;</span>userServiceImpl<span style="color:#960050;background-color:#1e0010">&#39;</span>: Unsatisfied dependency expressed through method <span style="color:#960050;background-color:#1e0010">&#39;</span>setUserMapper<span style="color:#960050;background-color:#1e0010">&#39;</span> parameter 0; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nested exception is org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">beans</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">BeanCreationException</span>: Error creating bean with name <span style="color:#960050;background-color:#1e0010">&#39;</span>userMapper<span style="color:#960050;background-color:#1e0010">&#39;</span> defined in file <span style="color:#f92672">[/</span>IdeaProjects<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>classes<span style="color:#f92672">/</span>cn<span style="color:#f92672">/</span>luckyray<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>dao<span style="color:#f92672">/</span>main<span style="color:#f92672">/</span>UserMapper.<span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>: Cannot resolve reference to bean <span style="color:#960050;background-color:#1e0010">&#39;</span>mainSqlSessionTemplate<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">while</span> setting bean property <span style="color:#960050;background-color:#1e0010">&#39;</span>sqlSessionTemplate<span style="color:#960050;background-color:#1e0010">&#39;</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nested exception is org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">beans</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">UnsatisfiedDependencyException</span>: Error creating bean with name <span style="color:#960050;background-color:#1e0010">&#39;</span>mainSqlSessionTemplate<span style="color:#960050;background-color:#1e0010">&#39;</span> defined in <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">path</span> resource <span style="color:#f92672">[</span>cn<span style="color:#f92672">/</span>luckyray<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>DataSourceConfig.<span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>: Unsatisfied dependency expressed through method <span style="color:#960050;background-color:#1e0010">&#39;</span>sqlSessionTemplate<span style="color:#960050;background-color:#1e0010">&#39;</span> parameter 0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nested exception is org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">beans</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">BeanCreationException</span>: Error creating bean with name <span style="color:#960050;background-color:#1e0010">&#39;</span>mainSqlSessionFactory<span style="color:#960050;background-color:#1e0010">&#39;</span> defined in <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">path</span> resource <span style="color:#f92672">[</span>cn<span style="color:#f92672">/</span>luckyray<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>config<span style="color:#f92672">/</span>DataSourceConfig.<span style="color:#a6e22e">class</span><span style="color:#f92672">]</span>: Bean instantiation via factory method failed; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nested exception is org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">beans</span>.<span style="color:#a6e22e">BeanInstantiationException</span>: Failed to instantiate <span style="color:#f92672">[</span>org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">ibatis</span>.<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">SqlSessionFactory</span><span style="color:#f92672">]</span>: Factory method <span style="color:#960050;background-color:#1e0010">&#39;</span>sqlSessionFactory<span style="color:#960050;background-color:#1e0010">&#39;</span> threw exception; nested exception is org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NestedIOException</span>: Failed to parse mapping resource: <span style="color:#960050;background-color:#1e0010">&#39;</span>file <span style="color:#f92672">[/</span>IdeaProjects<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>classes<span style="color:#f92672">/</span>mapping<span style="color:#f92672">/</span>main<span style="color:#f92672">/</span>UserMapper.<span style="color:#a6e22e">xml</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nested exception is org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">ibatis</span>.<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">BuilderException</span>: Error parsing Mapper XML. The XML location is <span style="color:#960050;background-color:#1e0010">&#39;</span>file <span style="color:#f92672">[/</span>IdeaProjects<span style="color:#f92672">/</span>evaluation<span style="color:#f92672">/</span>target<span style="color:#f92672">/</span>classes<span style="color:#f92672">/</span>mapping<span style="color:#f92672">/</span>main<span style="color:#f92672">/</span>UserMapper.<span style="color:#a6e22e">xml</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">&#39;</span>. Cause: org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">ibatis</span>.<span style="color:#a6e22e">builder</span>.<span style="color:#a6e22e">BuilderException</span>: Error resolving <span style="color:#66d9ef">class</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#a6e22e">Cause</span>: org.<span style="color:#a6e22e">apache</span>.<span style="color:#a6e22e">ibatis</span>.<span style="color:#a6e22e">type</span>.<span style="color:#a6e22e">TypeException</span>: Could not resolve type alias <span style="color:#960050;background-color:#1e0010">&#39;</span>java1.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">Integer</span><span style="color:#960050;background-color:#1e0010">&#39;</span>.  Cause: java.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">ClassNotFoundException</span>: Cannot find <span style="color:#66d9ef">class</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#a6e22e">java1</span>.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">Integer</span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// 这其实是一行异常信息，我用换行分离出来 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 层层嵌套，将必要的信息给暴露出来。</span>
</span></span></code></pre></div><p>不要在细节消息中包含密码、密钥以及类似的信息。输出异常消息日志时，或者正常日志时，一定要对敏感信息（用户名密码，用户名等等信息）进行脱敏操作。</p>
<h2 id="努力使失败保持原子性">努力使失败保持原子性<a hidden class="anchor" aria-hidden="true" href="#努力使失败保持原子性">#</a></h2>
<p>一般而言，失败的方法调用应该使对象保持在被调用之前的状态。</p>
<p>使用 JDBC 操作数据库进行增/删/改时，出现失败的情况，应该进行事务回滚。</p>
<p>分布式系统中的 GET 操作即使失败，也要保持幂等性。</p>
<p>// TODO Spring Cloud 的中就是这么 GET 默认为幂等的，会一直调用，直到你没出错为止。这个就需要提到 HATEOS 以及 RESTful 的一些约定的一些内容。</p>
<h2 id="不要忽略异常">不要忽略异常<a hidden class="anchor" aria-hidden="true" href="#不要忽略异常">#</a></h2>
<p>空的 catch 块会使异常达不到应有的目的。</p>
<p>如果选择忽略异常，catch 块中应该包含一条注释，说明情况，并将异常变量命名成 ignored</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">catch</span>(TimeoutException <span style="color:#f92672">|</span> ExecutionException ignored){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这是一条注释</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="concurrency">Concurrency<a hidden class="anchor" aria-hidden="true" href="#concurrency">#</a></h1>
<h2 id="同步访问共享的可变数据">同步访问共享的可变数据<a hidden class="anchor" aria-hidden="true" href="#同步访问共享的可变数据">#</a></h2>
<p>不要使用 Thread#stop 方法。</p>
<p>除非读和写操作都被同步，否则无法保证同步能起作用。</p>
<p>避免线程不安全的条件，可以有，避免共享，没有共享就没有伤害，使用 Synchronized/volatile/Atomic 类保证线程安全。</p>
<h2 id="避免过度同步">避免过度同步<a hidden class="anchor" aria-hidden="true" href="#避免过度同步">#</a></h2>
<p>使用 JUC 容器，如CopyOnWriteArrayList。</p>
<p>// TODO 死锁代码</p>
<h2 id="executortaskstream-优先于线程">executor、task、stream 优先于线程<a hidden class="anchor" aria-hidden="true" href="#executortaskstream-优先于线程">#</a></h2>
<p>不要用 Executors 创建线程池，里面具体实现有无界队列，Integer.MAX_VALUE 等坑人的定义。无界队列会一直堆积请求，直到OOM，应该使用 ArrayBlockingQueue 这种有界队列。使用 Guava 中 ThreadFactoryBuilder 创建 ThreadFactory，而不是继承原生的（不仅麻烦，而且很多东西其实是重复的，就是为了给线程加个名字和其他一些自定义的内容），也可以用 Spring 的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ThreadFactory namedThreadFactory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadFactoryBuilder()
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">setNameFormat</span>(<span style="color:#e6db74">&#34;demo-pool-%d&#34;</span>).<span style="color:#a6e22e">build</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 核心线程数，最大线程数，等待时间，时间单位，线程队列（应该用有界队列 ArrayBlockingQueue），线程工厂（继承 ThreadFactory），系统自带的拒绝策略 4 种 </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ExecutorService pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadPoolExecutor(5, 200,
</span></span><span style="display:flex;"><span>        0L, TimeUnit.<span style="color:#a6e22e">MILLISECONDS</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> LinkedBlockingQueue<span style="color:#f92672">&lt;</span>Runnable<span style="color:#f92672">&gt;</span>(1024), namedThreadFactory, <span style="color:#66d9ef">new</span> ThreadPoolExecutor.<span style="color:#a6e22e">AbortPolicy</span>());
</span></span></code></pre></div><h3 id="饱和策略">饱和策略<a hidden class="anchor" aria-hidden="true" href="#饱和策略">#</a></h3>
<ol>
<li>AbortPolicy：中止策略是默认的饱和策略，该策略将抛出未检查的 RejectedExecutionException 调用者可以捕获这个异常，然后根据需求编写自己的处理代码。</li>
<li>DiscardPolicy：当新提交的任务无法保存到队列中等待执行时，抛弃策略会悄悄抛弃该任务。</li>
<li>CallerRunsPolicy：调用者运行（Caller-Runs）策略实现了一种调节机制，该策略既不会抛弃任务，也不会抛弃异常，而是将某些任务回退到调用者，从而降低新任务的流量。它不会在线程池的某个线程中执行新提交的任务，而是在一个调用了 execute 的线程中执行该任务。</li>
<li>DiscardOldestPolicy：抛弃最旧的（Discard-Oldest）策略则会抛弃下一个将被执行的任务，然后尝试重新提交新的任务。如果工作队列是一个优先队列，那么”抛弃最旧的“策略将导致抛弃优先级最高的任务，因此最好不要将“抛弃最旧的”饱和策略和优先级队列放在一起使用。</li>
</ol>
<p>ForkJoinTask。// TODO 《Java 并发编程的艺术》解释，以及代码。Redis 子线程 Fork 父线程，进行集群同步。</p>
<p>并发的 Stream 是在 Fork Join 池上编写的。</p>
<h2 id="并发工具优先于-wait-和-notify">并发工具优先于 wait 和 notify<a hidden class="anchor" aria-hidden="true" href="#并发工具优先于-wait-和-notify">#</a></h2>
<ul>
<li>Executor FrameWork</li>
<li>JUC 容器 ConcurrentHashMap（而不是 Collections.synchronizedMap/HashTable）</li>
<li>同步器 CountDownLatch，Semaphore,CyclicBarrier 和 Exchanger 等</li>
</ul>
<p>对于间歇式的定时，始终应该优先使用 System.nanoTime 而不是 System.currentTimeMillis</p>
<p>// TODO Spring 同步机制代码补充</p>
<p>始终应该使用 wait 循环模式来调用 wait 方法，永远不要在循环之外调用 wait 方法。</p>
<p>一般情况下，优先使用 notifyAll 方法。// 极客时间《并发编程》代码补充</p>
<h2 id="线程安全性的文档化">线程安全性的文档化<a hidden class="anchor" aria-hidden="true" href="#线程安全性的文档化">#</a></h2>
<p>一个类为了可被多个线程安全地使用，必须在文档中清楚地说明它所支持的线程安全性级别。</p>
<ul>
<li>不可变的（immutable）—— String、Long、BigInteger</li>
<li>无条件的线程安全（unconditionally  thread-safe）—— 这个类的实例是可变的，但是这个类有着足够的内部同步。AtomicInteger、ConcurrentHashMap</li>
<li>有条件的线程安全（conditionally thread-safe）—— 除了有些方法为进行安全的并发使用而需要外部同步之外，和无条件的线程安全相同。Collections.synchronized 包装返回的集合。</li>
<li>非线程安全（not thread-safe）—— 类实例是可变的。ArrayList、HashMap</li>
<li>线程对立的（thread-hostile）—— 类不能安全地被多个线程并发使用，即使所有的方法调用都被外部同步包围。// TODO ThreadLocal？</li>
</ul>
<p>使用类内部私有锁对象。lock 域应该始终声明为 final。// TODO Spring 中也是这么做的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Object lock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object();
</span></span></code></pre></div><h2 id="慎用延迟初始化">慎用延迟初始化<a hidden class="anchor" aria-hidden="true" href="#慎用延迟初始化">#</a></h2>
<p>Lazy Initialization 是指延迟到需要域的值时才将它初始化的行为。Spring Boot 中有 @Lazy 标注是否延迟初始化，如果标记了，则将会该 Bean 进行延迟初始化，只有在其他类真正使用时，进行初始化。</p>
<p><strong>大多数情况下，非延迟初始化优先于延迟初始化。</strong></p>
<p>如果初始化耗时长，那我们最好不要等到真正要用它的时候，才去执行这个耗时长的初始化过程，这会影响到系统的性能（比如，在响应客户端接口请求的时候，做这个初始化操作，会导致此请求的响应时间变长，甚至超时）</p>
<p>除非绝对必要，否则就不要这么做。</p>
<p><strong>如果处于性能的考虑而需要对静态域使用延迟初始化，就使用 Lazy Initiazlization Holder Class 模式</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Singleton</span>(){}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SingletonHolder</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Singleton INSTANCE <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Singleton();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">getInstance</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SingletonHolder.<span style="color:#a6e22e">INSTANCE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>如果出于性能的考虑而需要对实例域使用延迟初始化，就使用双重检查模式（Double-Check Idiom）</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Singleton</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> Singleton instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 构造器检查，防止反射多次创建</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Singleton</span>(){<span style="color:#66d9ef">if</span>(instance <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>)<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException()};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Singleton <span style="color:#a6e22e">getInstance</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(instance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">synchronized</span>(Singleton.<span style="color:#a6e22e">class</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(instance <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                    instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Singleton();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> instance;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Spring 中使用单例注册表（Bean 容器）控制 Bean 的单例。</p>
<p><strong>有时可能需要延迟初始化一个可以接受重复初始化的实例域。可以使用单重检查模式（Single-Check Idiom）</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> FieldType field;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> FieldType <span style="color:#a6e22e">getField</span>(){
</span></span><span style="display:flex;"><span>    FieldType result <span style="color:#f92672">=</span> filed;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>        field <span style="color:#f92672">=</span> result <span style="color:#f92672">=</span> computeFieldValue()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="不要依赖于线程调度器">不要依赖于线程调度器<a hidden class="anchor" aria-hidden="true" href="#不要依赖于线程调度器">#</a></h2>
<p><strong>任何依赖于线程调度器来达到正确性或者性能要求的程序，很有可能都是不可移植的</strong></p>
<p>如果一个程序不能工作，是因为某些线程无法像其他线程那样获得足够的 CPU 时间片，那么，不要企图调用 Thread.yield 来 “修正” 该程序。</p>
<p>线程优先级时 Java 平台上最不可移植的特征了。设置了优先级，不代表一定会按优先级执行，而是“看情况”。</p>
<h1 id="serialize">Serialize<a hidden class="anchor" aria-hidden="true" href="#serialize">#</a></h1>
<h2 id="其他方法优先于-java-序列化">其他方法优先于 Java 序列化<a hidden class="anchor" aria-hidden="true" href="#其他方法优先于-java-序列化">#</a></h2>
<p>如果使用 Java 自带的反序列化，以下层次非常高的结构，会导致系统反序列化时占用大量资源。使用 JSON 代替 Java 中的序列化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">bomb</span>(){
</span></span><span style="display:flex;"><span>	Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> root <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> s1 <span style="color:#f92672">=</span> root;
</span></span><span style="display:flex;"><span>    Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> s2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(ini i <span style="color:#f92672">=</span> 0;i <span style="color:#f92672">&lt;</span> 100; i<span style="color:#f92672">++</span>){ 
</span></span><span style="display:flex;"><span>        Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> t2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        t1.<span style="color:#a6e22e">add</span>(<span style="color:#e6db74">&#34;foo&#34;</span>);
</span></span><span style="display:flex;"><span>        s1.<span style="color:#a6e22e">add</span>(t1);
</span></span><span style="display:flex;"><span>        s1.<span style="color:#a6e22e">add</span>(t2);
</span></span><span style="display:flex;"><span>        s2.<span style="color:#a6e22e">add</span>(t1);
</span></span><span style="display:flex;"><span>        s2.<span style="color:#a6e22e">add</span>(t2);
</span></span><span style="display:flex;"><span>        s1 <span style="color:#f92672">=</span> t1;
</span></span><span style="display:flex;"><span>        s2 <span style="color:#f92672">=</span> t2;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> serialize(root);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="谨慎地实现-serializable-接口">谨慎地实现 Serializable 接口<a hidden class="anchor" aria-hidden="true" href="#谨慎地实现-serializable-接口">#</a></h2>
<p>BigInteger、Instant 等值类应该实现 Serializable 接口，大多数的集合类也应该如此。代表活动实体的类，如线程池，一般不应该实现 Seriallizable 接口。</p>
<p>内部类不该实现 Serializable。</p>
<h2 id="考虑使用自定义的序列化形式">考虑使用自定义的序列化形式<a hidden class="anchor" aria-hidden="true" href="#考虑使用自定义的序列化形式">#</a></h2>
<p>跨语言的 Socket 通信，是自己实现序列化机制，包括 Redis，是以纯文本格式，换行的方式分隔操作符。</p>
<p>transient 表示该字段不能被序列化，当然实现了 // TODO 实现某个接口后，在方法中写明了字段，也是可以序列化的。</p>
<h2 id="保护性地编写-readobject-方法">保护性地编写 readObject 方法<a hidden class="anchor" aria-hidden="true" href="#保护性地编写-readobject-方法">#</a></h2>
<p>当一个对象被反序列化的时候，对于客户端不应该拥有的对象引用，如果哪个域包含了这样的对象引用，必须做保护性拷贝。</p>
<h2 id="对于实例控制枚举类型优先于-readobject">对于实例控制，枚举类型优先于 readObject<a hidden class="anchor" aria-hidden="true" href="#对于实例控制枚举类型优先于-readobject">#</a></h2>
<p>// TODO 不太理解</p>
<h2 id="考虑用序列化代理代替序列化实例">考虑用序列化代理代替序列化实例<a hidden class="anchor" aria-hidden="true" href="#考虑用序列化代理代替序列化实例">#</a></h2>
<p>使用静态内部类，代理外部类序列化内容，以及反序列化。</p>
<p>// TODO 代码</p>
<h1 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h1>
<blockquote>
<p><a href="https://juejin.im/post/5c6698b6f265da2da23d17a8">关于Integer面试的一个问题</a></p></blockquote>
<blockquote>
<p><a href="https://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html">VM系列三:JVM参数设置、分析</a></p></blockquote>
<blockquote>
<p><a href="http://mail.openjdk.java.net/pipermail/hotspot-compiler-dev/2008-April/000110.html">What does AggressiveOpts do with my timings?</a></p></blockquote>
<blockquote>
<p><a href="https://segmentfault.com/a/1190000010799123">科普：为什么 String hashCode 方法选择数字31作为乘子</a></p></blockquote>
<blockquote>
<p><a href="https://cloud.tencent.com/developer/article/1593982">https://cloud.tencent.com/developer/article/1593982</a></p></blockquote>
<blockquote>
<p><a href="https://blog.csdn.net/xx326664162/article/details/51743969">https://blog.csdn.net/xx326664162/article/details/51743969</a></p></blockquote>
<blockquote>
<p><a href="https://zhuanlan.zhihu.com/p/43161690">无声的性能杀手-伪共享(FalseSharing)</a></p></blockquote>
<blockquote>
<p><a href="https://juejin.im/post/6844903873346453518">重学Java-一个Java对象到底占多少内存</a></p></blockquote>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/effective-java/">Effective Java</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">YL&#39;s Log</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
